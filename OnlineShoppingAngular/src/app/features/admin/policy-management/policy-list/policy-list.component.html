<div class="admin-layout">
  <app-admin-header></app-admin-header>
  <div class="admin-main">
    <app-admin-sidebar></app-admin-sidebar>
    <main class="admin-content">
      <div class="policy-list-container">
        <!-- Page Header -->
        <div class="page-header mb-4">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h2 class="mb-1">Policy Management</h2>
              <p class="text-muted mb-0">Manage privacy policies, terms & conditions, and other legal documents</p>
            </div>
            <button class="btn btn-primary" routerLink="/admin/policy/policy-create">
              <i class="bi bi-plus-circle me-2"></i>Create New Policy
            </button>
          </div>
        </div>

        <!-- Alert Messages -->
        <div *ngIf="message" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle me-2"></i>
          {{ message }}
          <button type="button" class="btn-close" (click)="message = ''" aria-label="Close"></button>
        </div>

        <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle me-2"></i>
          {{ error }}
          <button type="button" class="btn-close" (click)="error = ''" aria-label="Close"></button>
        </div>

        <!-- Search and Filters -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Search Policies</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-search"></i>
                  </span>
                  <input type="text" class="form-control" placeholder="Search by title or description..." 
                         [(ngModel)]="searchTerm" (input)="onSearch()">
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Policy Type</label>
                <select class="form-select" [(ngModel)]="typeFilter" (change)="onFilterChange()">
                  <option value="">All Types</option>
                  <option *ngFor="let type of policyTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Items per page</label>
                <select class="form-select" [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()">
                  <option value="5">5 per page</option>
                  <option value="10">10 per page</option>
                  <option value="25">25 per page</option>
                  <option value="50">50 per page</option>
                </select>
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-secondary w-100" (click)="onReset()">
                  <i class="bi bi-arrow-clockwise me-1"></i>Reset
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Policy Table -->
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Policy List</h5>
              <small class="text-muted">{{ filteredPolicies.length }} of {{ policies.length }} policies</small>
            </div>
            <div class="d-flex align-items-center gap-2" *ngIf="!isLoading">
              <small class="text-muted">
                Page {{ currentPage }} of {{ totalPages }}
              </small>
            </div>
          </div>
          <div class="card-body p-0">
            <!-- Loading State -->
            <div *ngIf="isLoading" class="d-flex justify-content-center align-items-center py-5">
              <div class="spinner-border text-primary me-3" role="status"></div>
              <span class="text-muted">Loading policies...</span>
            </div>

            <!-- Table -->
            <div *ngIf="!isLoading" class="table-responsive">
              <table class="table table-hover mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 60px;">#</th>
                    <th style="width: 25%;" class="sortable" (click)="sort('title')">
                      <div class="d-flex align-items-center">
                        Title
                        <i class="bi ms-1" [class]="getSortIcon('title')"></i>
                      </div>
                    </th>
                    <th style="width: 40%;">Description</th>
                    <th style="width: 15%;" class="sortable" (click)="sort('type')">
                      <div class="d-flex align-items-center">
                        Type
                        <i class="bi ms-1" [class]="getSortIcon('type')"></i>
                      </div>
                    </th>
                    <th style="width: 120px;" class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let policy of paginatedPolicies; let i = index; trackBy: trackByPolicyId" class="table-row-hover">
                    <td>
                      <span class="fw-semibold text-primary">#{{ policy.id }}</span>
                    </td>
                    <td>
                      <div class="title-cell">
                        <span class="fw-semibold text-dark" [title]="policy.title">
                          {{ policy.title | slice:0:50 }}{{ policy.title && policy.title.length > 50 ? '...' : '' }}
                        </span>
                        <div class="policy-meta">
                          <small class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i>
                            ID: {{ policy.id }}
                          </small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="description-cell">
                        <div class="description-preview" [innerHTML]="getDescriptionPreview(policy.description)" 
                             [title]="getPlainTextDescription(policy.description)">
                        </div>
                        <button *ngIf="policy.description && policy.description.length > 150" 
                                class="btn btn-sm btn-outline-info mt-1" 
                                (click)="viewFullDescription(policy)">
                          <i class="bi bi-eye me-1"></i>View Full
                        </button>
                      </div>
                    </td>
                    <td>
                      <span class="badge" [class]="getTypeBadgeClass(policy.type)">
                        <i class="bi" [class]="getTypeIcon(policy.type)" class="me-1"></i>
                        {{ getTypeLabel(policy.type) }}
                      </span>
                    </td>
                    <td class="text-center">
                      <div class="btn-group" role="group">
                        <button class="btn btn-outline-primary btn-sm" 
                                (click)="editPolicy(policy.id!)" 
                                title="Edit Policy">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle dropdown-toggle-split"
                                data-bs-toggle="dropdown" aria-expanded="false" title="More Actions">
                          <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                          <li>
                            <a class="dropdown-item" href="#" (click)="editPolicy(policy.id!); $event.preventDefault()">
                              <i class="bi bi-pencil me-2"></i>Edit
                            </a>
                          </li>
                          <li>
                            <a class="dropdown-item" href="#" (click)="viewFullDescription(policy); $event.preventDefault()">
                              <i class="bi bi-eye me-2"></i>View Details
                            </a>
                          </li>
                          <li><hr class="dropdown-divider"></li>
                          <li>
                            <a class="dropdown-item text-danger" href="#" 
                               (click)="confirmDelete(policy); $event.preventDefault()">
                              <i class="bi bi-trash me-2"></i>Delete
                            </a>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Empty State -->
            <div *ngIf="!isLoading && paginatedPolicies.length === 0" class="text-center py-5">
              <div class="empty-state">
                <i class="bi bi-file-text display-1 text-muted mb-3"></i>
                <h5 class="text-muted">No policies found</h5>
                <p class="text-muted mb-3">
                  <span *ngIf="searchTerm || typeFilter">
                    No policies match your current filters. Try adjusting your search criteria.
                  </span>
                  <span *ngIf="!searchTerm && !typeFilter">
                    No policies have been created yet.
                  </span>
                </p>
                <div class="d-flex gap-2 justify-content-center">
                  <button class="btn btn-outline-primary" (click)="onReset()" 
                          *ngIf="searchTerm || typeFilter">
                    <i class="bi bi-arrow-clockwise me-1"></i>Clear All Filters
                  </button>
                  <button class="btn btn-primary" routerLink="/admin/policy/policy-create">
                    <i class="bi bi-plus-circle me-1"></i>Create First Policy
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination -->
          <div class="card-footer bg-light" *ngIf="!isLoading && totalPages > 1">
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">
                Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
                {{ Math.min(currentPage * itemsPerPage, totalItems) }} of {{ totalItems }} entries
              </div>
              <nav aria-label="Policy pagination">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="goToPreviousPage()" [disabled]="currentPage === 1">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                  </li>
                  <li *ngFor="let page of getPageNumbers()" class="page-item" [class.active]="page === currentPage">
                    <button class="page-link" (click)="goToPage(page)">{{ page }}</button>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link" (click)="goToNextPage()" [disabled]="currentPage === totalPages">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Policy Details Modal -->
<div class="modal fade" id="policyDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Policy Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" *ngIf="selectedPolicy">
        <div class="mb-3">
          <h6 class="text-muted mb-2">Title</h6>
          <p class="fw-semibold">{{ selectedPolicy.title }}</p>
        </div>
        <div class="mb-3">
          <h6 class="text-muted mb-2">Type</h6>
          <span class="badge" [class]="getTypeBadgeClass(selectedPolicy.type)">
            <i class="bi" [class]="getTypeIcon(selectedPolicy.type)" class="me-1"></i>
            {{ getTypeLabel(selectedPolicy.type) }}
          </span>
        </div>
        <div class="mb-3">
          <h6 class="text-muted mb-2">Description</h6>
          <div class="description-content" [innerHTML]="selectedPolicy.description"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" (click)="editPolicy(selectedPolicy!.id!)" data-bs-dismiss="modal">
          <i class="bi bi-pencil me-1"></i>Edit Policy
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <i class="bi bi-exclamation-triangle text-warning display-4 mb-3"></i>
          <h6>Are you sure you want to delete this policy?</h6>
          <p class="text-muted mb-0" *ngIf="policyToDelete">
            <strong>{{ policyToDelete.title | slice:0:50 }}{{ policyToDelete.title && policyToDelete.title.length > 50 ? '...' : '' }}</strong> will be permanently removed.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deletePolicy(policyToDelete!.id!)" data-bs-dismiss="modal">
          <i class="bi bi-trash me-1"></i>Delete
        </button>
      </div>
    </div>
  </div>
</div>
