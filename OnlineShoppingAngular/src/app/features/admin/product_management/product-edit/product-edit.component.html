<div class="create-product-container">
    <!-- Clean Navigation Bar -->
    <div class="navigation-bar">
        <div class="nav-left">
            <div>
                <h1 class="nav-title">Edit Product</h1>
                <p class="nav-subtitle">Update product details, variants and images</p>
            </div>
        </div>
        <div class="nav-right">
            <button type="button" class="btn btn-outline-secondary" (click)="backToDetail()">
                <i class="fas fa-arrow-left me-2"></i>Back to Detail
            </button>
        </div>
    </div>

    <div class="main-content-product">
        <form id="productForm" [formGroup]="productForm" (ngSubmit)="onSubmit()">

            <!-- Two Column Layout -->
            <div class="row">
                <!-- Left Column - Basic Info & Images -->
                <div class="col-lg-6">
                    <!-- Basic Information Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle me-2"></i>Basic Information
                            </h3>
                            <p class="card-subtitle">Essential product details and categorization</p>
                        </div>
                        <div class="card-body">
                            <div class="form-grid">
                                <!-- Product Name -->
                                <div class="form-group">
                                    <label for="name" class="form-label">
                                        Product Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="name" class="form-control" [class.error]="hasError('name')"
                                        formControlName="name" placeholder="Enter product name">
                                    <div class="error-message" *ngIf="hasError('name')">
                                        {{ getErrorMessage('name') }}
                                    </div>
                                </div>

                                <!-- Brand - READ ONLY BADGE -->
                                <div class="form-group">
                                    <label class="form-label">Brand</label>
                                    <div class="readonly-field">
                                        <span class="badge bg-secondary fs-6 p-2" *ngIf="selectedBrand; else noBrand">
                                            <i class="fas fa-tag me-2"></i>{{ selectedBrand.name }}
                                        </span>
                                        <ng-template #noBrand>
                                            <span class="badge bg-light text-muted fs-6 p-2">
                                                <i class="fas fa-question-circle me-2"></i>No Brand Selected
                                            </span>
                                        </ng-template>
                                    </div>
                                    <small class="text-muted">Brand cannot be changed during edit</small>
                                </div>

                                <!-- Category - READ ONLY BADGE -->
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <div class="readonly-field">
                                        <span class="badge bg-primary fs-6 p-2"
                                            *ngIf="selectedCategory; else noCategory">
                                            <i class="fas fa-folder me-2"></i>{{ getSelectedCategoryPath() }}
                                        </span>
                                        <ng-template #noCategory>
                                            <span class="badge bg-light text-muted fs-6 p-2">
                                                <i class="fas fa-question-circle me-2"></i>No Category Selected
                                            </span>
                                        </ng-template>
                                    </div>
                                    <small class="text-muted">Category cannot be changed during edit</small>
                                </div>

                                <!-- Base Price -->
                                <div class="form-group">
                                    <label for="basePrice" class="form-label">
                                        Base Price <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">MMK</span>
                                        <input type="text" class="form-control" [value]="displayPrice"
                                            (input)="onDisplayPriceInput($event)" mask="separator" thousandSeparator=","
                                            decimalMarker="." [dropSpecialCharacters]="false" placeholder="0.00" />
                                        <input type="hidden" formControlName="basePrice" />
                                    </div>
                                    <div class="error-message" *ngIf="hasError('basePrice')">
                                        {{ getErrorMessage('basePrice') }}
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label for="description" class="form-label">
                                    Description <span class="text-danger">*</span>
                                </label>
                                <textarea id="description" class="form-control" [class.error]="hasError('description')"
                                    formControlName="description" rows="3"
                                    placeholder="Enter product description"></textarea>
                                <div class="error-message" *ngIf="hasError('description')">
                                    {{ getErrorMessage('description') }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Images Card -->
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title">
                                        <i class="fas fa-images me-2"></i>Product Images
                                    </h3>
                                    <p class="card-subtitle">Upload and manage product images ({{ imagePool.length
                                        }}/10)</p>
                                </div>
                                <button type="button" class="btn btn-primary-offer" [disabled]="imagePool.length >= 10"
                                    (click)="triggerImageUpload()">
                                    <i class="fas fa-plus me-2"></i>Add Images
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Image Pool Grid -->
                            <div class="row g-2 mb-2" *ngIf="imagePool.length > 0">
                                <div class="col-6 col-md-4" *ngFor="let img of imagePool; let i = index">
                                    <div class="position-relative image-pool-item">
                                        <img [src]="img.previewUrl" alt="Preview" class="img-thumbnail w-100"
                                            style="height: 80px; object-fit: cover;">
                                        <!-- Remove Button -->
                                        <button type="button" class="btn btn-danger btn-sm position-absolute"
                                            style="top: -8px; right: -8px; font-size: 0.7rem; width: 20px; height: 20px; padding: 0;"
                                            (click)="removeImageFromPool(img.id)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        <!-- Main Image Button -->
                                        <button type="button" class="btn btn-sm position-absolute"
                                            style="bottom: -8px; left: -8px; font-size: 0.7rem; width: 24px; height: 20px; padding: 0;"
                                            [class.btn-success]="img.isMain" [class.btn-warning]="!img.isMain"
                                            (click)="setMainImage(img.id)" title="Set as main image">
                                            <i class="fas fa-star"></i>
                                        </button>
                                        <!-- Reorder Controls -->
                                        <div class="position-absolute reorder-controls"
                                            style="top: -8px; left: -8px; display: flex; flex-direction: column; gap: 2px;">
                                            <button type="button" class="btn btn-secondary btn-sm"
                                                style="font-size: 0.6rem; width: 18px; height: 16px; padding: 0;"
                                                [disabled]="!canMoveUp(img.id)" (click)="moveImageUp(img.id)"
                                                title="Move up">
                                                <i class="fas fa-chevron-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-secondary btn-sm"
                                                style="font-size: 0.6rem; width: 18px; height: 16px; padding: 0;"
                                                [disabled]="!canMoveDown(img.id)" (click)="moveImageDown(img.id)"
                                                title="Move down">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                        <!-- Main Badge -->
                                        <span *ngIf="img.isMain" class="badge bg-success position-absolute"
                                            style="top: 2px; left: 2px; font-size: 0.6rem;">Main</span>
                                        <!-- Display Order Badge -->
                                        <span class="badge bg-primary position-absolute"
                                            style="bottom: 2px; right: 2px; font-size: 0.6rem;">
                                            {{ img.displayOrder }}
                                        </span>
                                        <!-- <span class="badge bg-primary position-absolute"
                                            style="bottom: 2px; right: 2px; font-size: 0.6rem;">{{ i + 1 }}</span> -->
                                    </div>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div *ngIf="imagePool.length === 0" class="empty-state">
                                <i class="fas fa-images"></i>
                                <h3>No images uploaded</h3>
                                <p>Add product images to showcase your product</p>
                                <button type="button" class="btn btn-primary-offer" (click)="triggerImageUpload()">
                                    + Add First Image
                                </button>
                            </div>

                            <input type="file" #productFileInput class="d-none" (change)="onImagesSelected($event)"
                                accept="image/*" multiple>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Options -->
                <div class="col-lg-6">
                    <!-- Product Options Card -->
                    <div class="card option-card-wrapper">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="card-title">
                                        <i class="fas fa-cogs me-2"></i>Product Options ({{ getTotalOptionsCount() }})
                                    </h3>
                                    <p class="card-subtitle">Manage existing options and add new option types</p>
                                </div>
                                <button type="button" class="btn btn-primary-offer" (click)="addOption()">
                                    <i class="fas fa-plus me-2"></i>Add Option Type
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Options List -->
                            <div style="max-height: 600px; overflow-y: auto;" class="rounded p-2 bg-white">
                                <div formArrayName="options" class="options-container">
                                    <!-- Existing Options (Read-only) -->
                                    <div *ngFor="let option of options.controls; let i = index" [formGroupName]="i"
                                        class="option-card mb-2" [class.existing-option]="isExistingOption(i)">
                                        <div class="option-header">
                                            <div class="d-flex align-items-center gap-3">
                                                <span class="option-badge" [class.bg-info]="isExistingOption(i)"
                                                    [class.bg-success]="!isExistingOption(i)">{{ i + 1 }}</span>
                                                <div>
                                                    <h4 class="option-title">{{
                                                        getOptionTypeName(option.get('id')?.value) }}</h4>
                                                    <small class="text-muted" *ngIf="isExistingOption(i)">
                                                        <i class="fas fa-lock me-1"></i>Existing option - add values
                                                        only
                                                    </small>
                                                    <small class="text-muted" *ngIf="!isExistingOption(i)">
                                                        <i class="fas fa-plus me-1"></i>New option type
                                                    </small>
                                                </div>
                                            </div>
                                            <!-- Remove button only for new options -->
                                            <button *ngIf="!isExistingOption(i)" type="button"
                                                class="btn btn-sm btn-outline-secondary" (click)="removeNewOption(i)">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>

                                        <div class="option-body">

                                            <!-- Existing Option (Read-only type, editable values) -->
                                            <div *ngIf="isExistingOption(i)" class="form-grid-single">
                                                <!-- Option Values -->
                                                <div class="form-group">
                                                    <!-- Existing Values (Non-removable) -->
                                                    <div class="existing-values mb-2"
                                                        *ngIf="getExistingValuesForOption(i).length > 0">
                                                        <small class="text-muted mb-1 d-block">
                                                            <i class="fas fa-lock me-1"></i>Existing values (cannot be
                                                            removed):
                                                        </small>
                                                        <div class="selected-values">
                                                            <span class="badge bg-light text-dark border me-1 mb-1"
                                                                *ngFor="let val of getExistingValuesForOption(i)">
                                                                <i class="fas fa-database me-1 text-muted"
                                                                    title="Existing value"></i>
                                                                {{ val }}
                                                            </span>
                                                        </div>
                                                    </div>

                                                    <!-- Available Values for Selection -->
                                                    <div class="dropdown">
                                                        <button
                                                            class="btn btn-outline-secondary dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center"
                                                            type="button" [id]="'optionDropdown' + i"
                                                            data-bs-toggle="dropdown" aria-expanded="false">
                                                            <span class="dropdown-text">
                                                                <span *ngIf="getNewSelectedValuesCount(i) === 0"
                                                                    class="text-muted">
                                                                    Add more values
                                                                </span>
                                                                <span *ngIf="getNewSelectedValuesCount(i) > 0"
                                                                    class="text-dark">
                                                                    {{ getNewSelectedValuesCount(i) }} additional
                                                                    selected
                                                                </span>
                                                            </span>
                                                        </button>
                                                        <ul class="dropdown-menu w-100"
                                                            [attr.aria-labelledby]="'optionDropdown' + i">
                                                            <li *ngFor="let value of getAvailableValuesForOption(i)">
                                                                <div class="dropdown-item-check px-3 py-1">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            [id]="'option_' + i + '_' + value.id"
                                                                            [checked]="isValueSelected(i, value.value)"
                                                                            [disabled]="isExistingValue(i, value.value)"
                                                                            (change)="toggleOptionValue(i, value.value)" />
                                                                        <label
                                                                            class="form-check-label small d-flex align-items-center"
                                                                            [for]="'option_' + i + '_' + value.id">
                                                                            <span>{{ value.value }}</span>
                                                                            <i *ngIf="isExistingValue(i, value.value)"
                                                                                class="fas fa-database ms-2 text-muted"
                                                                                title="Already selected"></i>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                            <li *ngIf="getAvailableValuesForOption(i)?.length === 0">
                                                                <span class="dropdown-item-text small text-muted">No
                                                                    additional values available</span>
                                                            </li>
                                                            <li>
                                                                <button type="button"
                                                                    class="dropdown-item text-primary small"
                                                                    (click)="openAddOptionValueDialog(option.get('id')?.value)">
                                                                    + Add new value
                                                                </button>
                                                            </li>
                                                        </ul>
                                                    </div>

                                                    <!-- New Selected Values Display (Removable) -->
                                                    <div class="new-values mt-2"
                                                        *ngIf="getNewSelectedValues(i).length > 0">
                                                        <small class="text-success mb-1 d-block">
                                                            <i class="fas fa-plus me-1"></i>Newly added values:
                                                        </small>
                                                        <div class="selected-values">
                                                            <span class="badge bg-success text-white me-1 mb-1"
                                                                *ngFor="let val of getNewSelectedValues(i)">
                                                                <i class="fas fa-plus-circle me-1"
                                                                    title="New value"></i>
                                                                {{ val }}
                                                                <button type="button"
                                                                    class="btn-close btn-close-white btn-close-sm ms-1"
                                                                    (click)="removeOptionValue(i, val)"
                                                                    aria-label="Remove"></button>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- New Option (Fully editable) -->
                                            <div *ngIf="!isExistingOption(i)" class="form-grid-single">
                                                <!-- Option Type -->
                                                <div class="form-group">
                                                    <label class="form-label">Option Type</label>
                                                    <div class="input-group">
                                                        <select class="form-select" formControlName="id"
                                                            (change)="onNewOptionTypeChange(i)"
                                                            [class.error]="option.get('id')?.invalid && option.get('id')?.touched">

                                                            <option [ngValue]="null">Select Type</option>
                                                            <option *ngFor="let type of getAvailableOptionTypes()"
                                                                [ngValue]="type.id">
                                                                {{ type.name }}
                                                            </option>


                                                            <!-- <option value="">Select Type</option>
                                                            <option *ngFor="let type of getAvailableOptionTypes()" [value]="type.id">
                                                                {{ type.name }}
                                                            </option> -->
                                                        </select>
                                                        <button type="button" class="btn btn-outline-secondary"
                                                            (click)="openAddOptionDialog()">+</button>
                                                    </div>
                                                    <div class="error-message"
                                                        *ngIf="option.get('id')?.invalid && option.get('id')?.touched">
                                                        Option type is required
                                                    </div>
                                                </div>

                                                <!-- Option Values -->
                                                <div class="form-group">
                                                    <label class="form-label">Option Values</label>
                                                    <div *ngIf="option.get('id')?.value; else noTypeSelected"
                                                        class="dropdown">
                                                        <button
                                                            class="btn btn-outline-secondary dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center"
                                                            type="button" [id]="'newOptionDropdown' + i"
                                                            data-bs-toggle="dropdown" aria-expanded="false"
                                                            [class.error]="option.get('values')?.invalid && option.get('values')?.touched">
                                                            <span class="dropdown-text">
                                                                <span *ngIf="getSelectedValuesCount(i) === 0"
                                                                    class="text-muted">Select values</span>
                                                                <span *ngIf="getSelectedValuesCount(i) > 0"
                                                                    class="text-dark">{{
                                                                    getSelectedValuesCount(i) }} selected</span>
                                                            </span>
                                                        </button>
                                                        <ul class="dropdown-menu w-100"
                                                            [attr.aria-labelledby]="'newOptionDropdown' + i">
                                                            <li
                                                                *ngFor="let value of getOptionValues(option.get('id')?.value)">
                                                                <div class="dropdown-item-check px-3 py-1">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            [id]="'new_option_' + i + '_' + value.id"
                                                                            [checked]="isValueSelected(i, value.value)"
                                                                            (change)="toggleOptionValue(i, value.value)" />
                                                                        <label class="form-check-label small"
                                                                            [for]="'new_option_' + i + '_' + value.id">
                                                                            {{ value.value }}
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                            <li
                                                                *ngIf="getOptionValues(option.get('id')?.value)?.length === 0">
                                                                <span class="dropdown-item-text small text-muted">No
                                                                    values available</span>
                                                            </li>
                                                            <li>
                                                                <button type="button"
                                                                    class="dropdown-item text-primary small"
                                                                    (click)="openAddOptionValueDialog(option.get('id')?.value)">
                                                                    + Add new value
                                                                </button>
                                                            </li>
                                                        </ul>
                                                        <div class="error-message"
                                                            *ngIf="option.get('values')?.invalid && option.get('values')?.touched">
                                                            Please select at least one value
                                                        </div>
                                                    </div>

                                                    <ng-template #noTypeSelected>
                                                        <button class="btn btn-outline-secondary w-100 text-start"
                                                            type="button" disabled>
                                                            <span class="text-muted small">Select type first</span>
                                                        </button>
                                                    </ng-template>

                                                    <!-- Selected Values Display -->
                                                    <div class="selected-values mt-1"
                                                        *ngIf="option.get('values')?.value?.length > 0">
                                                        <span class="badge bg-light text-dark border me-1 mb-1"
                                                            *ngFor="let val of option.get('values')?.value">
                                                            {{ val }}
                                                            <button type="button" class="btn-close btn-close-sm ms-1"
                                                                (click)="removeOptionValue(i, val)"
                                                                aria-label="Remove"></button>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- No Options Message -->
                                    <div *ngIf="options.length === 0" class="empty-state">
                                        <i class="fas fa-cogs"></i>
                                        <h3>No options configured</h3>
                                        <p>This product has no variant options</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Assignment Section (shown when new options are added) -->
            <div class="card" *ngIf="hasNewOptionsRequiringAssignment()">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="card-title">
                                <i class="fas fa-hand-point-right me-2"></i>Manual Option Assignment
                            </h3>
                            <p class="card-subtitle">
                                <span class="badge bg-warning me-2">Action Required</span>
                                Assign new option values to existing variants
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>New option types detected!</strong>
                        Please assign values for the new options to each existing variant.
                        New variants will be generated only for unassigned combinations.
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Existing Variant</th>
                                    <th *ngFor="let newOption of getNewOptions()">
                                        {{ getOptionTypeName(newOption.get('id')?.value) }}
                                        <span class="badge bg-success ms-1">New</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let variant of existingVariants; let i = index">
                                    <td>
                                        <div class="fw-semibold">{{ getExistingVariantDisplayLabel(variant) }}</div>
                                        <small class="text-muted">Existing variant #{{ i + 1 }}</small>
                                    </td>
                                    <td *ngFor="let newOption of getNewOptions(); let optionIndex = index">
                                        <select class="form-select form-select-sm"
                                            [(ngModel)]="variantNewOptionAssignments[i][getOptionTypeName(newOption.get('id')?.value)]"
                                            [ngModelOptions]="{standalone: true}">
                                            <option value="">Select value</option>
                                            <option *ngFor="let value of newOption.get('values')?.value"
                                                [value]="value">
                                                {{ value }}
                                            </option>
                                        </select>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-success" (click)="applyManualAssignments()">
                            <i class="fas fa-check me-2"></i>Apply Assignments & Generate New Variants
                        </button>
                    </div>
                </div>
            </div>

            <!-- Product Variants Card - Full Width at Bottom -->
            <div class="card" *ngIf="getTotalVariantsCount() > 0">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="card-title">
                                <i class="fas fa-layer-group me-2"></i>Product Variants ({{ getTotalVariantsCount() }})
                            </h3>
                            <p class="card-subtitle">
                                <span *ngIf="existingVariants.length > 0" class="badge bg-info me-2">{{
                                    existingVariants.length }} Existing</span>
                                <span *ngIf="newVariants.length > 0" class="badge bg-success me-2">{{ newVariants.length
                                    }} New</span>
                                <span *ngIf="hasUnassignedCombinations()" class="badge bg-warning me-2">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Pending Assignments
                                </span>
                                Manage pricing, stock, and images for each variant
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" (click)="applyBulkStock()">
                                Set Stock
                            </button>
                            <button type="button" class="btn btn-sm btn-primary-offer"
                                [class.btn-primary]="bulkAssignmentMode"
                                [class.btn-outline-primary]="!bulkAssignmentMode" (click)="toggleBulkAssignmentMode()">
                                <i class="fas fa-images me-1"></i>
                                {{ bulkAssignmentMode ? 'Exit Bulk Mode' : 'Bulk Assign Images' }}
                            </button>
                        </div>
                    </div>

                    <div *ngIf="bulkAssignmentMode" class="mt-2 p-2 bg-light rounded">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                        (click)="selectAllVariants()">
                                        Select All
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm"
                                        (click)="clearVariantSelection()">
                                        Clear
                                    </button>
                                </div>
                                <small class="text-muted">{{ getSelectedVariantsCount() }} variants selected</small>
                            </div>
                            <div class="col-md-5">
                                <select class="form-select form-select-sm" [(ngModel)]="selectedImageForBulkAssignment"
                                    [ngModelOptions]="{standalone: true}">
                                    <option value="">Select action</option>
                                    <option value="clear">🚫 Remove Images (No Images)</option>
                                    <option *ngFor="let img of imagePool; let i = index" [value]="img.id">
                                        Image {{ i + 1 }}{{ img.isMain ? ' (Main)' : '' }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary-offer btn-sm w-100"
                                    [disabled]="!selectedImageForBulkAssignment || getSelectedVariantsCount() === 0"
                                    (click)="applyBulkImageAssignment()">
                                    <i class="fas fa-check me-1"></i>
                                    {{ selectedImageForBulkAssignment === 'clear' ? 'Remove from Selected'
                                    : 'Apply to Selected' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div style="max-height: 400px; overflow-y: auto;" class="border rounded p-2 bg-white">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col" class="ps-3" style="width: 50px;">
                                            <input *ngIf="bulkAssignmentMode" type="checkbox" class="form-check-input"
                                                [checked]="getSelectedVariantsCount() === getTotalVariantsCount() && getTotalVariantsCount() > 0"
                                                (change)="getSelectedVariantsCount() === getTotalVariantsCount() ? clearVariantSelection() : selectAllVariants()">
                                            <span *ngIf="!bulkAssignmentMode">#</span>
                                        </th>
                                        <th scope="col" style="width: 80px;">Status</th>
                                        <th scope="col" style="width: 200px;">Variant</th>
                                        <th scope="col" style="width: 180px;">Image Assignment</th>
                                        <th scope="col" style="width: 120px;">Price (MMK)</th>
                                        <th scope="col" style="width: 100px;">Stock</th>
                                        <th scope="col">SKU</th>
                                        <th scope="col" style="width: 80px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody formArrayName="variants">
                                    <tr *ngFor="let variant of variants.controls; let i = index" [formGroupName]="i"
                                        [class.table-primary]="bulkAssignmentMode && isVariantSelected(i)"
                                        [class.table-light]="isExistingVariant(i)">
                                        <td class="ps-3">
                                            <input *ngIf="bulkAssignmentMode" type="checkbox" class="form-check-input"
                                                [checked]="isVariantSelected(i)" (change)="toggleVariantSelection(i)">
                                            <span *ngIf="!bulkAssignmentMode">{{ i + 1 }}</span>
                                        </td>

                                        <td>
                                            <span class="badge" [class]="getVariantStatusBadgeClass(i)">
                                                <i class="fas" [class.fa-database]="isExistingVariant(i)"
                                                    [class.fa-plus-circle]="!isExistingVariant(i)"></i>
                                                {{ getVariantStatusText(i) }}
                                            </span>
                                        </td>

                                        <td>
                                            <div class="variant-options">
                                                <div class="fw-semibold small mb-1">
                                                    {{ getVariantDisplayLabel(i) }}
                                                </div>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div *ngIf="getAssignedImage(i)" class="flex-shrink-0">
                                                    <img [src]="getAssignedImage(i)!.previewUrl" alt="Assigned image"
                                                        class="img-thumbnail"
                                                        style="width: 50px; height: 50px; object-fit: cover;">
                                                </div>
                                                <div *ngIf="!getAssignedImage(i)"
                                                    class="flex-shrink-0 d-flex align-items-center justify-content-center border rounded"
                                                    style="width: 50px; height: 50px; background-color: #f8f9fa;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                                <div *ngIf="!bulkAssignmentMode" class="flex-grow-1">
                                                    <select class="form-select form-select-sm"
                                                        formControlName="assignedImageId">
                                                        <option value="">No Image</option>
                                                        <option
                                                            *ngFor="let img of getAvailableImagesForVariant(); let imgIndex = index"
                                                            [value]="img.id">
                                                            {{ imgIndex + 1 }}{{ img.isMain ? ' (Main)' : '' }}
                                                        </option>
                                                    </select>
                                                </div>
                                                <div *ngIf="bulkAssignmentMode" class="flex-grow-1">
                                                    <span *ngIf="getAssignedImage(i)" class="text-success small">
                                                        <i class="fas fa-check-circle me-1"></i>Has Image
                                                    </span>
                                                    <span *ngIf="!getAssignedImage(i)" class="text-muted small">
                                                        <i class="fas fa-circle me-1"></i>No Image
                                                    </span>
                                                </div>
                                            </div>
                                        </td>

                                        <td>
                                            <app-price-display-input
                                                [control]="getFormControl(variant.get('price'))"></app-price-display-input>
                                        </td>

                                        <td>
                                            <input type="number" class="form-control form-control-sm"
                                                formControlName="stock" min="0" step="1">
                                        </td>

                                        <td class="small text-muted">
                                            <div class="d-flex align-items-center gap-2">
                                                <span>{{ getSkuForVariant(i) }}</span>
                                                <i *ngIf="isExistingVariant(i)" class="fas fa-lock text-info"
                                                    title="Existing SKU - preserved"></i>
                                                <i *ngIf="!isExistingVariant(i)" class="fas fa-magic text-success"
                                                    title="New SKU - will be generated"></i>
                                            </div>
                                        </td>

                                        <td>
                                            <div class="d-flex gap-1">
                                                <button *ngIf="canRemoveVariant(i)" type="button"
                                                    class="btn btn-outline-danger btn-sm" style="padding: 2px 6px;"
                                                    (click)="removeVariant(i)" title="Remove this variant">
                                                    <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                                                </button>
                                                <span *ngIf="!canRemoveVariant(i)"
                                                    class="badge bg-warning text-dark small"
                                                    title="Existing variant cannot be removed">
                                                    <i class="fas fa-lock me-1"></i>Locked
                                                </span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Variants Message -->
            <div class="alert alert-info" *ngIf="getTotalVariantsCount() === 0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>No variants found.</strong>
                        <p class="mb-0 small">Add product options above to generate variants, or this product will use a
                            default variant.</p>
                    </div>
                </div>
            </div>

            <!-- Error Messages -->
            <div *ngIf="errorMessage" class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                {{ errorMessage }}
            </div>
        </form>

        <!-- Fixed Submit Button at Bottom -->
        <div class="fixed-submit-bar">
            <div class="container-fluid">
                <div class="d-flex justify-content-end">
                    <button type="submit" form="productForm" class="btn btn-primary-create btn-lg"
                        [disabled]="productForm.invalid || loading.submission || hasUnassignedCombinations()">
                        <span *ngIf="loading.submission" class="loading-spinner me-2"></span>
                        <i *ngIf="!loading.submission" class="fas fa-save me-2"></i>
                        {{ loading.submission ? 'Updating Product...' : 'Update Product' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialogs -->
<app-option-dialog [(visible)]="optionDialogVisible" [editingOption]="editingOption" (save)="onOptionTypeSaved($event)">
</app-option-dialog>

<app-option-value-dialog [(visible)]="optionValueDialogVisible" [selectedOption]="selectedOptionTypeForDialog"
    [editingValue]="editingOptionValue" (save)="onOptionValueSaved($event)">
</app-option-value-dialog>