<div class="create-discount-container" *ngIf="!showConditionBuilder && !showProductSelection">
  <!-- Enhanced Hero Header -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <h1 class="display-1 plain-header" style="color: #2d5b49">Create New Discount</h1>

  <form [formGroup]="discountForm" (ngSubmit)="onSubmit()" class="discount-form">
    <div class="form-layout">
      <!-- Basic Information Card -->
      <div class="info-card basic-info-section">
        <div class="card-header">
          <div class="header-content">
            <div class="header-text">
              <h2>Basic Information</h2>
              <p class="header-subtitle">Set up your discount </p>
            </div>
          </div>
         
        </div>
        <div class="card-content">
          <div class="form-section">
            <div class="form-group enhanced">
              <label for="name" class="enhanced-label">Discount Name <span class="required">*</span></label>
              <div class="input-wrapper">
                <input 
                  type="text"
                  id="name"
                  formControlName="name"
                  placeholder="e.g., Summer Sale 2024"
                  [class.error]="getFieldError('name')"
                  (input)="onDiscountNameChange($event)"
                  class="enhanced-input"
                >
                <div class="input-feedback" *ngIf="discountForm.get('name')?.value && !getFieldError('name')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </div>
              <div class="error-message" *ngIf="getFieldError('name')">
                {{ getFieldError('name') }}
              </div>
            </div>

            <div class="form-row enhanced">
            
            </div>

            <div class="form-group enhanced">
              <label for="description" class="enhanced-label">Description <span class="required">*</span></label>
              <div class="textarea-wrapper">
                <textarea 
                  id="description"
                  formControlName="description"
                  placeholder="Describe your discount offer in detail... What makes this offer special?"
                  rows="4"
                  [class.error]="getFieldError('description')"
                  class="enhanced-textarea"
                ></textarea>
                <div class="character-count">
                  {{ discountForm.get('description')?.value?.length || 0 }}/500
                </div>
              </div>
              <div class="field-hint">Help customers understand the value of your offer</div>
              <div class="error-message" *ngIf="getFieldError('description')">
                {{ getFieldError('description') }}
              </div>
            </div>

            <div class="form-row enhanced">
              <div class="form-group enhanced">
                <label for="startDate" class="enhanced-label">Start Date <span class="required">*</span></label>
                <input 
                  type="datetime-local"
                  id="startDate"
                  formControlName="startDate"
                  [class.error]="getFieldError('startDate')"
                  class="enhanced-input"
                >
                <div class="field-hint">When should this discount become active?</div>
                <div class="error-message" *ngIf="getFieldError('startDate')">
                  {{ getFieldError('startDate') }}
                </div>
              </div>

              <div class="form-group enhanced">
                <label for="endDate" class="enhanced-label">End Date <span class="required">*</span></label>
                <input 
                  type="datetime-local"
                  id="endDate"
                  formControlName="endDate"
                  [class.error]="getFieldError('endDate')"
                  class="enhanced-input"
                >
                <div class="field-hint">When should this discount expire?</div>
                <div class="error-message" *ngIf="getFieldError('endDate')">
                  {{ getFieldError('endDate') }}
                </div>
              </div>
            </div>

            <div class="form-row enhanced">
              <div class="form-group enhanced">
                <label for="usageLimit" class="enhanced-label">Total Usage Limit <span class="required">*</span></label>
                <input 
                  type="number"
                  id="usageLimit"
                  formControlName="usageLimit"
                  min="1"
                  placeholder="e.g., 100"
                  [class.error]="getFieldError('usageLimit')"
                  class="enhanced-input"
                >
                <div class="field-hint">Maximum number of times this discount can be used</div>
                <div class="error-message" *ngIf="getFieldError('usageLimit')">
                  {{ getFieldError('usageLimit') }}
                </div>
              </div>

              <div class="form-group enhanced">
                <label for="perUserLimit" class="enhanced-label">Per Customer Limit <span class="required">*</span></label>
                <input 
                  type="number"
                  id="perUserLimit"
                  formControlName="perUserLimit"
                  min="1"
                  placeholder="e.g., 1"
                  [class.error]="getFieldError('perUserLimit')"
                  class="enhanced-input"
                >
                <div class="field-hint">How many times each customer can use this</div>
                <div class="error-message" *ngIf="getFieldError('perUserLimit')">
                  {{ getFieldError('perUserLimit') }}
                </div>
              </div>
            </div>

            <!-- Enhanced Image Upload Section -->
            <div class="form-group enhanced">
              <label class="enhanced-label">Discount Image</label>
              <div class="image-upload-section">
                <div class="upload-area" [class.has-image]="imagePreviewUrl" [class.uploading]="isUploadingImage">
                  <input 
                    type="file"
                    #fileInput
                    accept="image/*"
                    (change)="onFileSelected($event)"
                    style="display: none"
                    [disabled]="isUploadingImage"
                  >
                  
                  <div *ngIf="!imagePreviewUrl && !isUploadingImage" class="upload-placeholder" (click)="fileInput.click()">
                    <div class="upload-icon">
                      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <polyline points="7,10 12,5 17,10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="5" x2="12" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </div>
                    <h4>Upload Discount Image</h4>
                    <p>Drag & drop or click to browse</p>
                    <small>PNG, JPG up to 5MB</small>
                  </div>

                  <div *ngIf="isUploadingImage" class="upload-progress-area">
                    <div class="upload-spinner">
                      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="loading-spinner">
                        <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
                      </svg>
                    </div>
                    <div class="upload-progress-info">
                      <h4>Uploading Image...</h4>
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="uploadProgress"></div>
                      </div>
                      <span class="progress-text">{{ uploadProgress }}%</span>
                    </div>
                  </div>

                  <div *ngIf="imagePreviewUrl && !isUploadingImage" class="image-preview-area">
                    <img [src]="imagePreviewUrl" alt="Discount Preview" class="preview-image" />
                    <div class="image-overlay">
                      <button type="button" class="change-image-btn" (click)="fileInput.click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V18C2 18.5304 2.21071 19.0391 2.58579 19.4142C2.96086 19.7893 3.46957 20 4 20H16C16.5304 20 17.0391 19.7893 17.4142 19.4142C17.7893 19.0391 18 18.5304 18 18V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Change
                      </button>
                      <button type="button" class="remove-image-btn" (click)="removeImage()" [disabled]="isUploadingImage">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Remove
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="field-hint">Add an attractive image to make your discount more appealing</div>
                <div *ngIf="errors['image']" class="error-message">
                  {{ errors['image'] }}
                </div>
              </div>
            </div>

            <!-- Enhanced Status Toggle -->
            <div class="form-group enhanced">
              <label class="enhanced-label">Discount Status</label>
              <div class="status-toggle-wrapper">
                <div class="toggle-switch enhanced">
                  <input 
                    type="checkbox"
                    id="isActive"
                    formControlName="isActive"
                    class="toggle-input"
                  >
                  <label for="isActive" class="toggle-label enhanced">
                    <span class="toggle-slider enhanced">
                      <span class="toggle-circle enhanced"></span>
                    </span>
                    <span class="toggle-text enhanced">
                      <span class="status-indicator" [class.active]="discountForm.get('isActive')?.value">
                        {{ discountForm.get('isActive')?.value ? 'Active' : 'Inactive' }}
                      </span>
                    </span>
                  </label>
                </div>
                <div class="field-hint">{{ discountForm.get('isActive')?.value ? 'Discount will be available to customers' : 'Discount will be hidden from customers' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Offer Types Card -->
      <div class="info-card offer-types-section">
        <div class="card-header">
          <div class="header-content">
            <div class="header-text">
              <h2>Offer Configuration</h2>
              <p class="header-subtitle">Design your discount mechanics</p>
            </div>
          </div>
          <div class="header-actions">
          
            <button type="button" class="add-offer-btn enhanced" (click)="addOfferType()">Add Offer</button>
          </div>
        </div>

        <div class="card-content">
          <div class="offer-options enhanced" formArrayName="discountMechanisms">
            <div 
              *ngFor="let mechanism of discountMechanisms.controls; let i = index"
              class="option-box enhanced"
              [formGroupName]="i"
            >
              <div class="option-header enhanced" style="color: #2d5b49;">
                <div class="option-title-wrapper">
                  <div class="option-badge">{{ i + 1 }}</div>
                  <div class="option-info">
                    <span class="option-title"><h4>Discount Option {{ i + 1 }}</h4></span>
                    <span class="option-subtitle">Configure your offer details</span>
                  </div>
                </div>
                <button type="button" class="remove-btn enhanced" (click)="removeOfferType(i)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>

              <div class="option-content enhanced" style="margin-top: -20px;">
                <div class="form-group enhanced">
                  <label class="enhanced-label">Offer Type</label>
                  <div class="offer-type-selector">
                    <div class="radio-group">
                      <label class="radio-option" [class.selected]="getMechanismGroup(i).get('mechanismType')?.value === mechanismTypes[0]">
                        <input type="radio" [value]="mechanismTypes[0]" formControlName="mechanismType">
                        <div class="radio-content">
                          <div class="radio-icon">💰</div>
                          <div class="radio-text">
                            <span class="radio-title">Percentage/Amount Discount</span>
                            <span class="radio-desc">Reduce price by percentage or fixed amount</span>
                          </div>
                        </div>
                      </label>
                      <label class="radio-option" [class.selected]="getMechanismGroup(i).get('mechanismType')?.value === mechanismTypes[1]">
                        <input type="radio" [value]="mechanismTypes[1]" formControlName="mechanismType">
                        <div class="radio-content">
                          <div class="radio-icon">🎁</div>
                          <div class="radio-text">
                            <span class="radio-title">Free Gift</span>
                            <span class="radio-desc">Give free products with purchase</span>
                          </div>
                        </div>
                      </label>
                      <label class="radio-option" [class.selected]="getMechanismGroup(i).get('mechanismType')?.value === mechanismTypes[2]">
                        <input type="radio" [value]="mechanismTypes[2]" formControlName="mechanismType">
                        <div class="radio-content">
                          <div class="radio-icon">🤝</div>
                          <div class="radio-text">
                            <span class="radio-title">Business to Business</span>
                            <span class="radio-desc">for customers who sell products back(B2B)</span>
                          </div>
                        </div>
                      </label>
                      <label class="radio-option" [class.selected]="getMechanismGroup(i).get('mechanismType')?.value === mechanismTypes[3]">
                        <input type="radio" [value]="mechanismTypes[3]" formControlName="mechanismType">
                        <div class="radio-content">
                          <div class="radio-icon">💳</div>
                          <div class="radio-text">
                            <span class="radio-title">Coupon</span>
                            <span class="radio-desc">for all customer who have coupon code</span>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Enhanced Discount Fields -->
                <div *ngIf="isDiscountMechanism(i) || isB2BMechanism(i) || isCouponMechanism(i)" class="discount-fields enhanced">
                  <div class="form-row enhanced">
                    <div class="form-group enhanced">
                      <label class="enhanced-label">Discount Type</label>
                      <div class="select-wrapper enhanced" style="width: 250px;"  style="width: 195px;">
                        <select formControlName="discountType" class="enhanced-select" >
                          <option [value]="getDiscountTypeValue('PERCENTAGE')">📈 Percentage (%)</option>
                          <option [value]="getDiscountTypeValue('FIXED')">💵 Fixed (MMK)</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-group enhanced">
                      <label class="enhanced-label">Value <span class="required">*</span></label>
                      <div class="value-input-wrapper">
                        <div class="input-group enhanced">
                          <input
                            type="number"
                          
                            formControlName="value"
                            class="enhanced-input"
                            style="width: 200px;"
                            [placeholder]="getMechanismGroup(i).get('discountType')?.value === getDiscountTypeValue('PERCENTAGE') ? 'Enter value             %' : 'Enter amount     MMK'"
                          />
                        
                        </div>
                       
                      </div>
                      <div class="error-message" class="error-message" *ngIf="getMechanismGroup(i).get('value')?.invalid && (getMechanismGroup(i).get('value')?.dirty || getMechanismGroup(i).get('value')?.touched)">
                        {{ getMechanismFieldError(i, 'value') }}
                        <span *ngIf="getMechanismGroup(i).get('value')?.errors?.['min']">Value cannot be negative.</span>
                        <span *ngIf="getMechanismGroup(i).get('value')?.errors?.['max']">Value cannot be greater than 100%.</span>
                      
                      </div>
                    </div>
                  </div>

                  <!-- Maximum Discount Amount Field (for percentage discounts) -->
                  <div class="form-group enhanced" *ngIf="showMaxDiscountAmount(i)">
                    <label class="enhanced-label">Maximum Discount Amount <span>*</span></label>
                    <div class="value-input-wrapper" style="display: flex; align-items: center; gap: 16px;">
                      <input 
                        type="text"
                        inputmode="decimal"
                        formControlName="maxDiscountAmount"
                        placeholder="eg.100                     MMK"
                        min="0"
                        step="0.01"
                        [class.error]="getMechanismFieldError(i, 'maxDiscountAmount')"
                        class="enhanced-input"
                        style="width:200px;"
                      >
                    </div>
                    <div class="field-hint">Cap the maximum discount amount for percentage discounts</div>
                    <div class="error-message" *ngIf="getMechanismFieldError(i, 'maxDiscountAmount')">
                      {{ getMechanismFieldError(i, 'maxDiscountAmount') }}
                    </div>
                  </div>

                  <!-- Coupon Code Field/Button (for Coupon mechanism type) -->
                  <div class="form-group enhanced" *ngIf="isCouponMechanism(i)">
                    <label class="enhanced-label">Coupon Code <span class="required">*</span></label>
                    <div class="value-input-wrapper" style="display: flex; align-items: center; gap: 16px;">
                      <input
                        type="text"
                        [formControlName]="'couponcode'"
                        placeholder="Coupon code"
                        class="enhanced-input"
                        readonly
                        style="width: 200px;"
                      >
                      <button type="button" class="generate-btn enhanced" (click)="generateCouponCodeForMechanism(i)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Generate
                      </button>
                    </div>
                    <div class="field-hint">Generate a unique coupon code for customers to use</div>
                            <div class="error-message" *ngIf="getMechanismGroup(i).get('couponcode')?.invalid && (getMechanismGroup(i).get('couponcode')?.dirty || getMechanismGroup(i).get('couponcode')?.touched)">
          <span *ngIf="getMechanismGroup(i).get('couponcode')?.errors?.['required']">Coupon code is required.</span>
          <span *ngIf="getMechanismGroup(i).get('couponcode')?.errors?.['minlength']">Coupon code must be at least 3 characters.</span>
        </div>
                  </div>

                  <!-- Enhanced Action Buttons -->
                  <div class="action-section enhanced">
                    
                    <div class="action-grid">
                      <div class="action-item">
                        <label class="action-label">Products</label>
                         <div class="action-content">
                          <button 
                            type="button" 
                            class="action-btn primary" 
                            (click)="onAddDiscountProduct(i)"
                            [disabled]="hasDiscountProducts(i)"
                          >
                            <span class="btn-text">Add Products</span>
                          </button>
                          <div *ngIf="hasDiscountProducts(i)" class="status-badge success">
                            <span class="status-text">{{ getDiscountProductCount(i) }} selected</span>
                            <button type="button" class="clear-btn" (click)="clearDiscountProducts(i)">
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                               <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- <div class="action-item">
                        <label class="action-label">Service</label>
                        <div class="action-content">
                          <button 
                            type="button" 
                            class="action-btn secondary" 
                            (click)="openServiceDescriptionModal(i)"
                            [disabled]="hasServiceDescription(i)"
                          >
                            <span class="btn-text">Add Service</span>
                          </button>
                          <div *ngIf="hasServiceDescription(i)" class="status-badge info">
                            <span class="status-text">{{ getServiceDescription(i) | slice:0:20 }}{{ getServiceDescription(i).length > 20 ? '...' : '' }}</span>
                            <button type="button" class="clear-btn" (click)="clearServiceDescription(i)">
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div> -->

                      <div class="action-item">
                        <label class="action-label">Conditions</label>
                        <div class="action-content">
                          <button 
                            type="button" 
                            class="action-btn accent" 
                            (click)="openConditionBuilder(i)"
                            [disabled]="hasCondition(i)">
                            <span class="btn-text">Add Condition</span>
                          </button>
                          <div class="condition-tags enhanced">
                            <div *ngFor="let condition of getConditionsForMechanism(i); let condIndex = index" class="condition-tag enhanced">
                              <span class="tag-text">Condition {{ condIndex + 1 }}</span>
                              <button type="button" class="remove-condition-btn" (click)="removeCondition(i, condIndex)">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>



                  </div>
                </div>

                <!-- Enhanced Free Gift Fields -->
                <div *ngIf="isFreeGiftMechanism(i)" class="free-gift-fields enhanced">
                  <div class="form-group enhanced">
                    <label class="enhanced-label">Quantity <span class="required">*</span></label>
                    <div class="quantity-selector">
                      <button 
                        type="button"
                        class="quantity-btn decrease"
                        (click)="decrementQuantity(i)"
                        [disabled]="getMechanismGroup(i).get('quantity')?.value <= 1"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                      <input 
                        type="number"
                        formControlName="quantity"
                        placeholder="1"
                        min="1"
                        pattern="[0-9]*"
                        [class.error]="getMechanismFieldError(i, 'quantity')"
                        class="quantity-input"
                        readonly
                      >
                      <button 
                        type="button"
                        class="quantity-btn increase"
                        (click)="incrementQuantity(i)"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                          <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </div>
                    <div class="field-hint">Number of free items to give</div>
                    <div class="error-message" *ngIf="getMechanismFieldError(i, 'quantity')">
                      {{ getMechanismFieldError(i, 'quantity') }}
                    </div>
                  </div>

                  <div class="action-section enhanced">
                    <div class="action-grid">
                      <div class="action-item">
                        <label class="action-label">Free Gifts</label>
                        <div class="action-content">
                          <button 
                            type="button"
                            class="action-btn gift"
                            (click)="onAddFreeGift(i)"
                            [disabled]="hasFreeGiftProducts(i)"
                          >
                            <span class="btn-text">Add Gifts</span>
                          </button>
                          <div *ngIf="hasFreeGiftProducts(i)" class="status-badge gift">
                            <span class="status-text">{{ getFreeGiftProductCount(i) }} gifts selected</span>
                            <button type="button" class="clear-btn" (click)="clearFreeGiftProducts(i)">
                              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="action-item">
                        <label class="action-label">Conditions</label>
                        <div class="action-content">
                          <button 
                            type="button" 
                            class="action-btn accent" 
                            (click)="openConditionBuilder(i)"
                          >
                            <span class="btn-text">Add Condition</span>
                          </button>
                          <div class="condition-tags enhanced">
                            <div *ngFor="let condition of getConditionsForMechanism(i); let condIndex = index" class="condition-tag enhanced">
                              <span class="tag-text">Condition {{ condIndex + 1 }}</span>
                              <button type="button" class="remove-condition-btn" (click)="removeCondition(i, condIndex)">
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                  <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Enhanced Empty State -->
            <div *ngIf="discountMechanisms.length === 0" class="empty-state enhanced">
              <div class="empty-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="12" y1="16" x2="12.01" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <h3>No discount options configured</h3>
              <p>Add your first discount option to get started with creating attractive offers for your customers.</p>
              <button type="button" class="empty-action-btn" (click)="addOfferType()">
                <span class="btn-text">Add Your First Offer</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Error Messages -->
    <div *ngIf="errors['general']" class="general-error enhanced">
      <div class="error-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2"/>
          <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="error-content">
        <h4>Error</h4>
        <p>{{ errors['general'] }}</p>
      </div>
    </div>

    <!-- Enhanced Submit Section -->
    <div class="submit-section enhanced">
      <div class="submit-info">
        <div class="form-summary">
          <h4>Ready to create your discount?</h4>
          <p>Review your settings and click create to make your discount live</p>
        </div>
      </div>
      <div class="submit-buttons enhanced">
        <button 
          type="button"
          class="reset-btn enhanced"
          (click)="resetForm()"
          [disabled]="isSubmitting"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12Z" stroke="currentColor" stroke-width="2"/>
            <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span class="btn-text">Reset Form</span>
        </button>
        <button 
          type="submit"
          class="create-btn enhanced"
          [disabled]="!isCreateDiscountEnabled() || isSubmitting || isUploadingImage"
          [class.loading]="isSubmitting"
        >
          <div class="btn-content">
            <svg *ngIf="!isSubmitting" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <polyline points="20,6 9,17 4,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div *ngIf="isSubmitting" class="loading-spinner">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <span class="btn-text">
              {{ isSubmitting ? 'Creating Discount...' : 'Create Discount' }}
            </span>
          </div>
        </button>
      </div>
    </div>
  </form>
</div>

<!-- Product Selection Component -->
<ng-container *ngIf="showProductSelection">
  <app-product-selection
    [context]="productSelectionContext"
    [selectionMode]="productSelectionMode"
    [selectedProducts]="getSelectedProductsForCurrentContext()"
    (onBack)="onProductSelectionBack()"
    (onProductsSelected)="onProductsSelected($event)">
  </app-product-selection>
</ng-container>

<!-- Condition Builder Component -->
<ng-container *ngIf="showConditionBuilder">
  <app-discount-rules 
    [currentMechanismIndex]="currentMechanismIndex"
    [selectedOfferType]="getSelectedOfferType(currentMechanismIndex)"
    [rules]="rules"
    [selectedProductsMap]="selectedProductsMap"
    (onBack)="onConditionBuilderBack()"
    (onSaveConditions)="onSaveConditions($event)"
    (rulesChange)="onRulesChange($event)"
    (openProductSelection)="onOpenProductSelection($event)">
  </app-discount-rules>
</ng-container>

<!-- Enhanced Service Description Modal -->
<div *ngIf="showServiceDescriptionModal" class="modal-overlay enhanced" (click)="closeServiceDescriptionModal()">
  <div class="modal-content enhanced" (click)="$event.stopPropagation()">
    <div class="modal-header enhanced">
      <div class="modal-title-section">
        <div class="modal-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="modal-title-text">
          <h3>Add Service Description</h3>
          <p>Describe the service included with this discount</p>
        </div>
      </div>
      <button class="modal-close-btn enhanced" (click)="closeServiceDescriptionModal()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    
    <div class="modal-body enhanced">
      <div class="form-group enhanced">
        <label class="enhanced-label">Service Description</label>
        <div class="textarea-wrapper enhanced">
          <textarea 
            [(ngModel)]="currentServiceDescription"
            (input)="onServiceDescriptionInput()"
            placeholder="e.g., Free installation, Free maintenance, Free consultation..."
            maxlength="100"
            rows="4"
            class="service-textarea enhanced">
          </textarea>
          <div class="character-counter enhanced">
            <span class="counter-text">{{ currentServiceDescription.length }}/100</span>
            <div class="counter-bar">
              <div class="counter-fill" [style.width.%]="(currentServiceDescription.length / 100) * 100"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="suggestions-section enhanced" *ngIf="serviceSuggestions.length > 0">
        <label class="suggestions-label">Quick Suggestions</label>
        <div class="suggestion-tags enhanced">
          <button 
            *ngFor="let suggestion of serviceSuggestions"
            type="button"
            class="suggestion-tag enhanced"
            (click)="applySuggestion(suggestion)">
            <span class="suggestion-icon">✨</span>
            <span class="suggestion-text">{{ suggestion }}</span>
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-actions enhanced">
      <button type="button" class="modal-btn secondary" (click)="closeServiceDescriptionModal()">
        <span class="btn-text">Cancel</span>
      </button>
      <button 
        type="button"
        class="modal-btn primary"
        (click)="saveServiceDescription()"
        [disabled]="!currentServiceDescription.trim()">
        <span class="btn-text">Add Service</span>
      </button>
    </div>
  </div>
</div>
