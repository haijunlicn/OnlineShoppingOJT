<div class="discount-rules-container" *ngIf="!showProductSelection">
  <!-- Navigation Header -->
  <div class="rules-navigation">
    <button class="back-button" (click)="handleBack()">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Discount Form
    </button>
    <h1 class="page-title">Condition Builder</h1>
  </div>

  <!-- Main Layout -->
  <div class="rules-layout">
    <!-- Left Column: Rule Builder -->
    <div class="rules-card">
      <div class="card-header">
        <h2 class="card-title">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4">
            </path>
          </svg>
          Add Conditions
        </h2>
      </div>

      <div class="card-content">
        <!-- Logic Type Selection -->
        <div class="logic-section">
          <label class="logic-label">Apply When</label>
          <select class="logic-select" [(ngModel)]="logicType">
            <option *ngFor="let option of logicOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <!-- Add Rule Button -->
        <button class="add-rule-button" (click)="addRule()">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add New Condition
        </button>

        <!-- Rules List -->
        <div class="rules-list">
          <div *ngFor="let rule of rules; let i = index" class="rule-card">
            <!-- Rule Header -->
            <div class="rule-header">
              <span class="rule-number">Condition {{ i + 1 }}</span>
              <button class="remove-rule-button" (click)="removeRule(rule.id)" title="Remove condition">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>

            <!-- Rule Type Selection -->
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Filter based on</label>
                <select class="form-select" [value]="rule.type"
                  (change)="onRuleTypeChange(rule, $any($event.target).value)">
                  <option value="">Select condition type</option>
                  <option *ngFor="let type of ruleTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Selected condition</label>
                <input class="form-input" [value]="getTypeLabel(rule.type)" readonly
                  placeholder="Type will appear here">
              </div>
            </div>

            <!-- Field Selection -->
            <div *ngIf="rule.type" class="form-grid">
              <div class="form-group">
                <label class="form-label">Select detail</label>
                <div class="custom-dropdown" [class.dropdown-up]="shouldShowDropdownUp(rule.id)"
                  [class.dropdown-down]="!shouldShowDropdownUp(rule.id)">
                  <button type="button" class="dropdown-trigger" (click)="toggleDropdown(rule.id)" #dropdownTrigger>
                    <span>{{ getFieldLabel(rule.type, rule.field) || 'Select condition detail' }}</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  <div *ngIf="dropdownOpen[rule.id]" class="dropdown-panel" (mouseleave)="closeDropdown(rule.id)">
                    <div *ngFor="let field of fieldOptions[rule.type]" class="dropdown-item"
                      (click)="onCustomDropdownSelect(rule, field.value)">
                      {{ field.label }}
                    </div>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Selected detail</label>
                <input class="form-input" [value]="getFieldLabel(rule.type, rule.field)" readonly
                  placeholder="Field will appear here">
              </div>
            </div>

            <!-- Operator Selection -->
            <div *ngIf="rule.type && rule.field" class="form-grid">
              <div class="form-group">
                <label class="form-label">Condition rule</label>
                <select class="form-select" [value]="rule.operator"
                  (change)="onRuleOperatorChange(rule, $any($event.target).value)">
                  <option value="">Select rule</option>
                  <option *ngFor="let op of getFilteredOperators(rule.type)" [value]="op.value">
                    {{ op.label }}
                  </option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Selected rule</label>
                <input class="form-input" [value]="getOperatorLabel(rule.operator)" readonly
                  placeholder="Operator will appear here">
              </div>
            </div>

            <!-- Values Section -->
            <div *ngIf="rule.type && rule.field && rule.operator" class="value-section">
              <label class="form-label">Enter the value of detail condition</label>

              <div *ngFor="let value of rule.values; let valueIndex = index" class="value-input-group">

                <!-- Product field handling -->
                <div *ngIf="rule.type === 'product' && rule.field === 'product'">
                  <input class="value-input" [value]="getProductNamesByIds(rule, valueIndex)" readonly
                    placeholder="Click button below to select products">

                  <!-- Selected Products Preview -->
                  <div *ngIf="hasSelectedProducts(rule.id, valueIndex)" class="selected-products">
                    <div *ngFor="let product of getSelectedProducts(rule.id, valueIndex); let idx = index"
                      class="product-tag">
                      <span>{{ product.name }}</span>
                      <button type="button" class="product-tag-remove"
                        (click)="removeSelectedProduct(rule.id, valueIndex, idx)" title="Remove product">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                      </button>
                    </div>
                  </div>

                  <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                    <button class="action-button" (click)="openProductSelectionModal(rule.id, valueIndex)">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                      </svg>
                      Select Products
                    </button>

                    <button
                      *ngIf="hasSelectedProducts(rule.id, valueIndex) && getSelectedProducts(rule.id, valueIndex).length > 1"
                      class="action-button clear-button" (click)="clearAllSelectedProducts(rule.id, valueIndex)">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                      </svg>
                      Clear All
                    </button>
                  </div>
                </div>

                <!-- Category field handling -->
                <!-- <div *ngIf="rule.type === 'product' && rule.field === 'category'">
                  <input class="value-input" [value]="value" readonly placeholder="Click button to select category">
                  <button class="action-button" (click)="openCategoryModal(rule.id, valueIndex)">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                      </path>
                    </svg>
                    Select Category
                  </button>
                </div> -->

                <!-- Brand field handling -->
                <!-- <div *ngIf="rule.type === 'product' && rule.field === 'brand'">
                  <input class="value-input" [value]="value" readonly placeholder="Click button to select brand">
                  <button class="action-button" (click)="openBrandModal(rule.id, valueIndex)">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                      </path>
                    </svg>
                    Select Brand
                  </button>
                </div> -->

                <!-- Category -->
                <div *ngIf="rule.type === 'product' && rule.field === 'category'">
                  <input class="value-input" [value]="getCategoryPreview(value)" readonly
                    placeholder="Click button to select category">
                  <button class="action-button" (click)="openCategoryModal(rule.id, valueIndex)">
                    <!-- SVG -->
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                      </path>
                    </svg>
                    Select Category
                  </button>
                </div>

                <!-- Brand -->
                <div *ngIf="rule.type === 'product' && rule.field === 'brand'">
                  <input class="value-input" [value]="getBrandPreview(value)" readonly
                    placeholder="Click button to select brand">
                  <button class="action-button" (click)="openBrandModal(rule.id, valueIndex)">
                    <!-- SVG -->
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                      </path>
                    </svg>
                    Select Brand
                  </button>
                </div>

                <!-- Shipping city handling -->
                <div *ngIf="rule.type === 'order' && rule.field === 'shipping_city'">
                  <input class="value-input" [value]="value" readonly placeholder="Click button to select city">
                  <button class="action-button" (click)="openMyanmarMapModal(rule.id, valueIndex)">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Select City
                  </button>
                </div>

                <!-- First order handling -->
                <div *ngIf="rule.type === 'order' && rule.field === 'first_order'">
                  <select class="form-select" [value]="value"
                    (change)="updateValue(rule.id, valueIndex, $any($event.target).value)">
                    <option value="">Select value</option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                  </select>
                </div>

                <!-- Customer Group handling -->
                <div *ngIf="rule.type === 'customer_group' && rule.field">
                  <select class="form-select" [value]="rule.values[0]"
                    (change)="updateValue(rule.id, 0, $any($event.target).value)">
                    <option value="">Select value</option>
                    <option value="true">True</option>
                    <option value="false">False</option>
                  </select>
                </div>

                <!-- Numeric inputs -->
                <div
                  *ngIf="(rule.type === 'order' && ['order_total', 'item_count', 'shipping_cost'].includes(rule.field)) || rule.type === 'status'">
                  <input #numInput type="number" class="value-input" [value]="value"
                    (input)="updateValue(rule.id, valueIndex, $any($event.target).value)"
                    placeholder="Enter numeric value">
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Preview -->
    <div class="preview-card">
      <div class="card-header">
        <h2 class="card-title">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
            </path>
          </svg>
          Rule Preview
        </h2>
      </div>

      <div class="preview-content">
        <div class="logic-display">
          <div class="logic-text">{{ getLogicLabel() }}</div>
        </div>

        <div *ngIf="rules.length === 0" class="empty-state">
          <div class="empty-icon">ðŸ“‹</div>
          <p class="font-medium">No conditions added yet</p>
          <p class="text-sm text-muted">Click "Add New Condition" to get started</p>
        </div>

        <div *ngIf="rules.length > 0" class="rules-preview">
          <div *ngFor="let rule of rules; let i = index" class="rule-preview">
            <div class="rule-preview-header">
              <span class="rule-preview-number">Condition {{ i + 1 }}:</span>
              <span class="rule-status" [class]="isRuleComplete(rule) ? 'rule-complete' : 'rule-incomplete'">
                {{ isRuleComplete(rule) ? 'âœ“ Complete' : 'âš  Incomplete' }}
              </span>
            </div>

            <div *ngIf="isRuleComplete(rule)" class="rule-preview-text">
              <strong>{{ getTypeLabel(rule.type) }}</strong> â†’
              <em>{{ getFieldLabel(rule.type, rule.field) }}</em>
              <span class="font-medium">{{ getOperatorLabel(rule.operator) }}</span>
              "{{ getJoinedValues(rule, i) }}"
            </div>

            <div *ngIf="!isRuleComplete(rule)" class="rule-preview-text text-muted">
              Incomplete condition - please fill all fields
            </div>
          </div>
        </div>

        <div class="bottom-actions">
          <button class="primary-button" [disabled]="!canSaveConditions()" (click)="handleSaveConditions()">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Save Conditions
          </button>
          <button class="secondary-button" (click)="handleCancel()">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Selection Modal -->
  <div *ngIf="showCategoryModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Select Category</h3>
        <button class="modal-close" (click)="showCategoryModal = false">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-search">
          <svg class="modal-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input class="modal-search-input" placeholder="Search categories..." [(ngModel)]="categorySearchText"
            (input)="onCategorySearch()">
        </div>

        <div class="modal-list">
          <div *ngFor="let category of filteredCategories" class="modal-item" (click)="onCategoryClick(category)">
            <input [type]="currentRuleOperator === 'one_of' ? 'checkbox' : 'radio'"
              [checked]="isCategorySelected(category)" (click)="$event.stopPropagation(); onCategoryClick(category)"
              name="categorySelect" />
            <span>{{ category.name }}</span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="secondary-button" (click)="showCategoryModal = false">Cancel</button>
        <button class="primary-button" (click)="confirmCategorySelection()">Done</button>
      </div>
    </div>
  </div>

  <!-- Brand Selection Modal -->
  <div *ngIf="showBrandModal" class="modal-overlay">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Select Brand</h3>
        <button class="modal-close" (click)="showBrandModal = false">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-search">
          <svg class="modal-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input class="modal-search-input" placeholder="Search brands..." [(ngModel)]="brandSearchText"
            (input)="onBrandSearch()">
        </div>

        <div class="modal-list">
          <div *ngFor="let brand of filteredBrands" class="modal-item" (click)="onBrandClick(brand)">
            <input [type]="currentRuleOperator === 'one_of' ? 'checkbox' : 'radio'" [checked]="isBrandSelected(brand)"
              (click)="$event.stopPropagation(); onBrandClick(brand)" name="brandSelect" />
            <span>{{ brand.name }}</span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="secondary-button" (click)="showBrandModal = false">Cancel</button>
        <button class="primary-button" (click)="confirmBrandSelection()">Done</button>
      </div>
    </div>
  </div>

  <!-- Myanmar Map Modal -->
  <div *ngIf="showMyanmarMapModal" class="modal-overlay">
    <div class="modal-container" style="max-width: 56rem;">
      <div class="modal-header">
        <h3 class="modal-title">Select City in Myanmar</h3>
        <button class="modal-close" (click)="showMyanmarMapModal = false">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-search">
          <svg class="modal-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input class="modal-search-input" placeholder="Search cities in Myanmar..." [(ngModel)]="citySearchText"
            (input)="onCitySearch()">
        </div>

        <div class="map-placeholder">
          <svg class="map-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
            style="width: 40px; height: 40px;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
          </svg>
          <h4 class="font-medium">Myanmar Map</h4>
          <p class="text-sm text-muted">Search and select a city from the list below</p>
        </div>

        <div class="city-grid">
          <div *ngFor="let city of filteredCities" class="city-item" [class.selected]="selectedCity === city.name"
            (click)="selectedCity = city.name">
            <div class="city-name">{{ city.name }}</div>
            <div class="city-region">{{ city.region }}</div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="secondary-button" (click)="showMyanmarMapModal = false">Cancel</button>
        <button class="primary-button" [disabled]="!selectedCity" (click)="selectCityFromModal()">
          Select {{ selectedCity }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Product Selection Component -->
<app-product-selection *ngIf="showProductSelection" context="condition_builder"
  [selectionMode]="productSelectionConfig.selectionMode" (onBack)="showProductSelection = false"
  (onProductsSelected)="handleProductsSelected($event)">
</app-product-selection>