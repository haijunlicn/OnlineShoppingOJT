<app-header></app-header>

<main class="main-content">
  <div class="container-fluid" *ngIf="product">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-section">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/customer/home">Home</a></li>
        <li class="breadcrumb-item"><a href="/customer/productList">Products</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ product.product.name }}</li>
      </ol>
    </nav>

    <!-- Updated Layout: Images (35%) + Details (40%) + Offers (25%) when discounts exist -->
    <div class="product-detail-layout" [class.has-discounts]="getVisibleDiscounts().length > 0">

      <!-- Column 1: Product Images (35% when discounts exist, 50% when no discounts) -->
      <div class="product-images-section">
        <div class="images-container">
          <!-- Main Image -->
          <div class="main-image-container">
            <div class="image-slider">
              <div *ngFor="let image of allImages; let i = index" [class.active]="currentImageIndex === i"
                class="slider-image">
                <img [src]="image.url" class="main-product-image" alt="{{ product.product.name }}" />
              </div>

              <!-- Navigation buttons -->
              <button class="slider-nav prev" (click)="prevImage()" *ngIf="allImages.length > 1">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button class="slider-nav next" (click)="nextImage()" *ngIf="allImages.length > 1">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>

            <div class="badge bg-primary position-absolute top-0 end-0 m-2" *ngIf="product.status">
              {{ product.status }}
            </div>
          </div>

          <!-- Thumbnail Images (Bottom) -->
          <div class="thumbnails-row">
            <div class="horizontal-thumbnails">
              <div *ngFor="let image of allImages; let i = index; trackBy: trackByImageUrl" class="thumbnail-wrapper"
                [class.active]="currentImageIndex === i" (click)="setActiveImage(i)">
                <img [src]="image.url" alt="Product thumbnail" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 2: Product Details (40% when discounts exist, 50% when no discounts) -->
      <div class="product-info-section">
        <div class="product-info-container">
          <!-- Product Header -->
          <div class="product-header">
            <h1 class="product-title">{{ product.product.name }}</h1>

            <div class="product-badges">
              <span class="badge bg-secondary me-2">{{ product.brand?.name || 'No Brand' }}</span>
              <span class="badge bg-info">{{ product.category.name }}</span>
            </div>
          </div>

          <!-- Enhanced Price Section -->
          <div class="price-section">
            <div class="price-display">
              <!-- Show discounted price if available -->
              <div *ngIf="hasActiveDiscounts(product.product!.id!); else regularPrice" class="discounted-pricing">
                <div class="current-price">
                  MMK {{ getDiscountedPrice(product.product!.id!) | number:'1.0-0' }}
                </div>
                <div class="original-price-line">
                  <s class="original-price">
                    MMK {{ getCurrentDisplayPrice() | number:'1.0-0' }}
                  </s>
                  <span class="savings-badge">
                    Save MMK {{ getSavingsAmount(product.product!.id!) | number:'1.0-0' }}
                  </span>
                </div>
              </div>

              <ng-template #regularPrice>
                <div class="current-price">
                  MMK {{ getCurrentDisplayPrice() | number:'1.0-0' }}
                </div>
              </ng-template>
            </div>
          </div>

          <!-- Stock Status -->
          <div class="stock-status">
            <span [class]="getStockClass()">
              <i class="bi" [ngClass]="getStockIcon()"></i>
              {{ getStockStatus() }}
            </span>
          </div>

          <!-- Product Options -->
          <div class="options-section" *ngIf="product.options.length > 0">
            <form [formGroup]="form">
              <div *ngFor="let option of product.options; trackBy: trackByOptionId" class="option-group">
                <label class="option-label">{{ option.name }}</label>
                <div class="option-values">
                  <div
                    *ngFor="let item of getOptionValuesWithAvailability(option.id, option.optionValues); trackBy: trackByOptionValue"
                    class="option-value-wrapper">
                    <button type="button" class="btn option-btn"
                      [class.btn-primary]="isSelected(option.id, item.value.id)"
                      [class.btn-outline-secondary]="!isSelected(option.id, item.value.id)" [disabled]="!item.enabled"
                      (click)="item.enabled && onOptionChange(option.id, item.value.id)">
                      {{ item.value.value }}
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- SKU -->
          <div class="sku-section" *ngIf="selectedVariant">
            <small class="text-muted">
              SKU: <span class="fw-bold">{{ selectedVariant.sku }}</span>
            </small>
          </div>

          <!-- Add to Cart Section -->
          <div class="add-to-cart-section">
            <div class="quantity-selector">
              <label class="quantity-label">Quantity:</label>
              <div class="input-group quantity-input">
                <button class="btn btn-outline-secondary" type="button" (click)="decrementQuantity()">-</button>
                <input type="number" class="form-control text-center" [(ngModel)]="quantity" min="1"
                  [max]="getCurrentVariantRemainingStock()">
                <button class="btn btn-outline-secondary" type="button" (click)="incrementQuantity()">+</button>
              </div>
            </div>

            <div class="action-buttons">
              <button class="btn btn-primary add-to-cart-btn" (click)="addToCart(this.product)" [disabled]="!isLoggedIn || 
                            !selectedVariant || 
                            selectedVariant.stock === 0 || 
                            getCurrentVariantRemainingStock() === 0">
                <i class="bi bi-cart-plus"></i>
                Add to Cart
              </button>

              <button class="btn btn-outline-secondary wishlist-btn" (click)="toggleWish(product.product.id!)"
                [disabled]="!isLoggedIn">
                <i class="pi" [ngClass]="isWished(product.product.id!) ? 'pi-heart-fill text-danger' : 'pi-heart'"></i>
              </button>
            </div>

            <!-- Cart Info -->
            <div class="cart-info" *ngIf="selectedVariant">
              <small class="text-muted">
                In Cart: {{ getCurrentVariantCartQuantity() }} |
                Remaining: {{ getCurrentVariantRemainingStock() }}
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Column 3: Horizontally Swipeable Offers Section (25%) -->
      <div class="offers-section" *ngIf="getVisibleDiscounts().length > 0">
        <div class="offers-container">
          <!-- Header -->
          <div class="offers-header">
            <div class="offers-title">
              <i class="pi pi-tag"></i>
              Special Offers
            </div>
            <div class="offers-count">{{ getVisibleDiscounts().length }} Available</div>
          </div>

          <!-- Swipeable Discount Cards -->
          <div class="discount-carousel-container">
            <div class="discount-carousel" #discountCarousel
              [style.transform]="'translateX(' + (-currentDiscountIndex * 100) + '%)'">
              <div *ngFor="let discount of getVisibleDiscounts(); let i = index" class="discount-card-slide">
                <div class="discount-card-compact" (click)="onOfferClicked(discount.id)">

                  <!-- Featured Banner for high-value discounts -->
                  <div class="featured-ribbon" *ngIf="isHighValueDiscount(discount)">
                    <span>FEATURED</span>
                  </div>

                  <!-- Main Discount Display -->
                  <div class="discount-main-compact">
                    <!-- Large Discount Value -->
                    <div class="discount-value-compact">
                      {{ getDiscountPercentage(discount) }}
                    </div>

                    <!-- Discount Type Label -->
                    <div class="discount-type-compact">
                      {{ getDiscountTypeLabel(discount) }}
                    </div>

                    <!-- Mechanism-based Description -->
                    <div class="discount-description-compact">
                      <div class="validity-info">{{ getDiscountInfoSections(discount).validity }}</div>
                      <div class="usage-limits-info">{{ getDiscountInfoSections(discount).usageLimits }}</div>
                    </div>

                    <!-- <div class="discount-description-compact">
                      {{ getMechanismBasedMessage(discount) }}
                    </div> -->

                    <!-- Coupon Code Display (for Coupon mechanism) -->
                    <div class="coupon-code-compact" *ngIf="discount.mechanismType === 'Coupon' && discount.couponcode">
                      <div class="code-box-compact" [class.copyable]="isConditionsMet(discount)">
                        <span class="code-text-compact">{{ discount.couponcode }}</span>
                        <button class="copy-code-btn-compact" *ngIf="isConditionsMet(discount)"
                          (click)="copyToClipboard(discount.couponcode); $event.stopPropagation()" title="Copy code">
                          <i class="pi pi-copy"></i>
                        </button>
                      </div>
                    </div>

                    <!-- View Detail Button -->
                    <button class="view-detail-btn" (click)="showDiscountDetail(discount); $event.stopPropagation()">
                      View Detail
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Navigation Dots -->
            <div class="carousel-dots" *ngIf="getVisibleDiscounts().length > 1">
              <button *ngFor="let discount of getVisibleDiscounts(); let i = index" class="dot"
                [class.active]="currentDiscountIndex === i" (click)="goToDiscountSlide(i)">
              </button>
            </div>

            <!-- Navigation Arrows (optional) -->
            <button class="carousel-nav prev" *ngIf="getVisibleDiscounts().length > 1 && currentDiscountIndex > 0"
              (click)="prevDiscountSlide()">
              <i class="pi pi-chevron-left"></i>
            </button>
            <button class="carousel-nav next"
              *ngIf="getVisibleDiscounts().length > 1 && currentDiscountIndex < getVisibleDiscounts().length - 1"
              (click)="nextDiscountSlide()">
              <i class="pi pi-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

  

    <!-- Product Details Tabs -->
    <div class="product-tabs-section">
      <div class="card">
        <div class="card-header">
          <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details"
                type="button" role="tab" aria-controls="details" aria-selected="true">
                Details
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="specifications-tab" data-bs-toggle="tab" data-bs-target="#specifications"
                type="button" role="tab" aria-controls="specifications" aria-selected="false">
                Specifications
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button"
                role="tab" aria-controls="reviews" aria-selected="false">Reviews</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="qanda-tab" data-bs-toggle="tab" data-bs-target="#qanda" type="button"
                role="tab" aria-controls="qanda" aria-selected="false">Q & A</button>
            </li>
           
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="productTabsContent">
            <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
              <h5>Product Description</h5>
              <p>{{ product.product.description }}</p>
            </div>
            <div class="tab-pane fade" id="specifications" role="tabpanel" aria-labelledby="specifications-tab">
              <table class="table table-striped">
                <tbody>
                  <tr>
                    <th scope="row">Brand</th>
                    <td>{{ product.brand?.name || 'No Brand' }}</td>
                  </tr>
                  <tr>
                    <th scope="row">Category</th>
                    <td>{{ product.category.name }}</td>
                  </tr>
                  <tr *ngFor="let option of product?.options">
                    <th scope="row">{{ option.name }}</th>
                    <td>
                      <span *ngFor="let value of option.optionValues; let last = last">
                        {{ value.value }}{{ !last ? ', ' : '' }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
              <!-- Enhanced Review Summary -->
              <div *ngIf="reviewTotal > 0" class="review-summary-enhanced">
                <div class="review-summary-header">
                  <div class="rating-overview">
                    <div class="average-rating-display">
                      <span class="rating-number">{{ reviewAverage | number:'1.1-1' }}</span>
                      <div class="rating-stars">
                        <ng-container *ngFor="let s of [1,2,3,4,5]">
                          <i class="bi" [ngClass]="s <= getRounded(reviewAverage) ? 'bi-star-fill' : 'bi-star'"></i>
                        </ng-container>
                      </div>
                      <span class="total-reviews">Based on {{ reviewTotal }} reviews</span>
                    </div>
                  </div>
                  
                  <div class="rating-breakdown">
                    <div *ngFor="let s of [5,4,3,2,1]" class="rating-bar-row">
                      <span class="star-count">{{s}} <i class="bi bi-star-fill"></i></span>
                      <div class="progress-bar-container">
                        <div class="progress-bar" [style.width.%]="(reviewBreakdown[s] || 0) / reviewTotal * 100"></div>
                      </div>
                      <span class="count-number">{{reviewBreakdown[s] || 0}}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Review Controls -->
              <div class="review-controls d-flex align-items-center justify-content-between flex-wrap">
                <div class="controls-left d-flex align-items-center flex-wrap">
                  <div class="sort-control me-3">
                    <label class="control-label">Sort by:</label>
                    <select [(ngModel)]="reviewSort" (change)="onReviewSortChange(reviewSort)" class="form-select form-select-sm">
                      <option value="date_desc">Newest First</option>
                      <option value="date_asc">Oldest First</option>
                      <option value="rating_desc">Highest Rated</option>
                      <option value="rating_asc">Lowest Rated</option>
                    </select>
                  </div>
                  <div class="filter-control">
                    <label class="control-label">Filter by:</label>
                    <select [(ngModel)]="reviewFilterRating" (change)="onReviewFilterChange(reviewFilterRating)" class="form-select form-select-sm">
                      <option [ngValue]="undefined">All Ratings</option>
                      <option *ngFor="let s of [5,4,3,2,1]" [ngValue]="s">{{s}} Star{{s > 1 ? 's' : ''}}</option>
                    </select>
                  </div>
                </div>
                <div class="controls-right d-flex align-items-center mt-2 mt-md-0">
                  <span class="reviews-count me-3">{{ reviews.length }} of {{ reviewTotal }} reviews</span>
                  <button *ngIf="isLoggedIn && hasPurchasedProduct && !hasReviewedProduct" class="btn btn-primary add-review-btn" (click)="openAddReviewModal()">
                    <i class="bi bi-plus-circle"></i> Add Review
                  </button>
                </div>
              </div>

              <!-- Loading State -->
              <div *ngIf="isLoadingReviews" class="loading-state">
                <div class="loading-spinner">
                  <div class="spinner"></div>
                  <p>Loading reviews...</p>
                </div>
              </div>

              <!-- Review List -->
              <div *ngIf="!isLoadingReviews && reviews.length > 0" class="review-list-enhanced">
                <div *ngFor="let review of reviews" class="review-card">
                  <div class="review-card-header">
                    <div class="reviewer-info">
                      <div class="reviewer-avatar">
                        <i class="bi bi-person-circle"></i>
                      </div>
                      <div class="reviewer-details">
                        <span class="reviewer-name">{{review.userName || 'Anonymous User'}}</span>
                        <div class="review-meta">
                          <span class="review-date">{{review.createdDate | date:'MMM dd, yyyy'}}</span>
                          <span *ngIf="review.verifiedPurchase" class="verified-badge">
                            <i class="bi bi-check-circle-fill"></i> Verified Purchase
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="review-rating">
                      <div class="star-display">
                        <ng-container *ngFor="let s of [1,2,3,4,5]">
                          <i class="bi" [ngClass]="s <= review.rating ? 'bi-star-fill' : 'bi-star'"></i>
                        </ng-container>
                      </div>
                      <span class="rating-text">{{review.rating}}/5</span>
                    </div>
                  </div>
                  
                  <div class="review-content">
                    <div class="review-icon-text-row">
                      <i class="bi bi-chat-quote review-quote-icon"></i>
                      <p class="review-text">{{review.comment}}</p>
                    </div>
                    
                    <div class="review-images" *ngIf="review.images?.length">
                      <div class="image-gallery">
                        <img *ngFor="let img of review.images" [src]="img.imageUrl" class="review-image" alt="Review image">
                      </div>
                    </div>
                  </div>
                  
                 <div class="review-actions" *ngIf="review.userId === userId">
  <button class="icon-btn edit-btn" data-bs-toggle="tooltip" title="Edit Review" (click)="openEditReview(review)">
    <i class="bi bi-pencil-square"></i>
  </button>
  <button class="icon-btn delete-btn" data-bs-toggle="tooltip" title="Delete Review" (click)="deleteReview(review)">
    <i class="bi bi-trash-fill"></i>
  </button>
</div>
                </div>
                
                <!-- Enhanced Pagination -->
                <nav class="pagination-container" *ngIf="getPages().length > 1">
                  <ul class="pagination pagination-sm">
                    <li class="page-item" [class.disabled]="reviewPage === 1">
                      <button class="page-link" (click)="onReviewPageChange(reviewPage-1)" [disabled]="reviewPage === 1">
                        <i class="bi bi-chevron-left"></i>
                      </button>
                    </li>
                    <li class="page-item" *ngFor="let p of getPages()" [class.active]="reviewPage === p">
                      <button class="page-link" (click)="onReviewPageChange(p)">{{p}}</button>
                    </li>
                    <li class="page-item" [class.disabled]="reviewPage === getPages().length">
                      <button class="page-link" (click)="onReviewPageChange(reviewPage+1)" [disabled]="reviewPage === getPages().length">
                        <i class="bi bi-chevron-right"></i>
                      </button>
                    </li>
                  </ul>
                </nav>
              </div>
              
              <!-- Empty State -->
              <div *ngIf="!isLoadingReviews && reviews.length === 0" class="empty-state">
                <div class="empty-state-content">
                  <i class="bi bi-chat-dots"></i>
                  <h5>No reviews yet</h5>
                  <p>Be the first to share your experience with this product!</p>
                </div>
              </div>

              <!-- Enhanced Review Form -->
              <!-- Removed inline review form -->

              <!-- Status Messages -->
              <div class="status-message" *ngIf="isLoggedIn && hasPurchasedProduct && hasReviewedProduct">
                <div class="alert alert-success">
                  <i class="bi bi-check-circle"></i>
                  <div class="message-content">
                    <h6>Review Submitted</h6>
                    <p>Thank you for your feedback! You have already reviewed this product.</p>
                  </div>
                </div>
              </div>

              <div class="status-message" *ngIf="!isLoggedIn || (isLoggedIn && !hasPurchasedProduct)">
                <div class="alert alert-info">
                  <i class="bi bi-info-circle"></i>
                  <div class="message-content">
                    <h6>Review Requirements</h6>
                    <p>You need to purchase and receive this product to write a review.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="qanda" role="tabpanel" aria-labelledby="qanda-tab">
              <app-productqanda [productId]="product.product.id || 0"></app-productqanda>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Related Products -->
    <div class="related-products-section" *ngIf="relatedProducts.length > 0">
      <h4>Related Products</h4>

      <button class="scroll-btn left" (click)="scrollLeft()">‹</button>

      <div class="related-products-scroll" #scrollContainer>
        <div class="product-card-container" *ngFor="let relatedProduct of relatedProducts">
          <div class="card h-100 product-card" (click)="goToDetail(relatedProduct)" style="cursor:pointer;">
            <div class="position-relative product-img-wrapper">
              <img [src]="getMainProductImage(relatedProduct)" class="card-img-top product-image" alt="Product Image" />
            </div>
            <div class="card-body product-info">
              <div class="d-flex justify-content-between align-items-center mb-2 brand-category-row">
                <small class="brand-text">{{ relatedProduct.brand?.name }}</small>
                <small class="category-text">{{ relatedProduct.category?.name }}</small>
              </div>
              <h6 class="product-name mb-3">
                {{ relatedProduct.name }}
              </h6>
              <div class="price-section mb-3">
                <span class="current-price fw-bold">
                  From MMK {{ relatedProduct.basePrice | number:'1.0-0' }}
                </span>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-auto">

                <span class="stock-badge"
                  [ngClass]="{'stock-in': hasStock(relatedProduct), 'stock-out': !hasStock(relatedProduct)}">
                  {{ hasStock(relatedProduct) ? 'In Stock' : 'Out of Stock' }}
                </span>

                <button class="btn btn-action btn-sm" (click)="goToDetail(relatedProduct); $event.stopPropagation()">
                  <i class="pi pi-eye me-1"></i>
                  View
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
      <button class="scroll-btn right" (click)="scrollRight()">›</button>
    </div>







  </div>
</main>

<!-- Enhanced Sticky Discount Progress Bar with Real Data -->
<!-- <app-sticky-discount-progress [conditionalDiscounts]="getConditionalDiscounts()" [currentAmount]="getCurrentCartTotal()"
  [cartItems]="cartItems" [currency]="'MMK'" (dismissed)="onStickyProgressDismissed()"
  (addMoreClicked)="onAddMoreItemsClicked()">
</app-sticky-discount-progress> -->


<!-- Enhanced Edit Review Modal -->
<div class="edit-review-modal" *ngIf="editingReview">
  <div class="edit-review-content">
    <div class="modal-header">
      <h5><i class="bi bi-pencil-square"></i> Edit Your Review</h5>
      <button type="button" class="custom-close-btn" (click)="closeEditReview()">
  <i class="bi bi-x-lg"></i> <!-- Bootstrap Icons X -->
</button>
    </div>
    
    <div class="modal-body">
      <div class="rating-input-section">
        <label class="form-label">Your Rating</label>
        <div class="star-rating-input">
          <ng-container *ngFor="let s of [1,2,3,4,5]">
            <i class="bi star-input" 
               [ngClass]="s <= editReviewData.rating ? 'bi-star-fill' : 'bi-star'"
               (click)="editReviewData.rating = s"
               [class.active]="s <= editReviewData.rating"></i>
          </ng-container>
          <span class="rating-label">{{editReviewData.rating}}/5</span>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Your Review</label>
        <textarea [(ngModel)]="editReviewData.comment" 
                  rows="4" 
                  class="form-control review-textarea"
                  placeholder="Share your thoughts about this product..."></textarea>
      </div>
      
      <!-- Enhanced Image Edit UI -->
      <div class="form-group" *ngIf="editReviewData.images && editReviewData.images.length">
        <label class="form-label">Edit Images</label>
        <div class="edit-images-grid">
          <div *ngFor="let img of editReviewData.images; let i = index" class="edit-image-item">
            <img [src]="img.imageUrl" alt="Review image">
            <div class="image-actions">
              <input type="file" accept="image/*" (change)="onEditReviewImageSelected($event, i)" style="display:none" #editImgInput>
              <button type="button" class="btn btn-sm btn-outline-primary" (click)="editImgInput.click()">
                <i class="bi bi-arrow-clockwise"></i> Replace
              </button>
              <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeEditReviewImage(i)">
                <i class="bi bi-trash"></i> Remove
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Add More Images</label>
        <div class="add-image-section">
          <input type="file" #addEditImgInput style="display:none" (change)="onAddEditReviewImageSelected($event)">
          <button type="button" class="btn btn-outline-success add-image-btn" (click)="addEditReviewImage(addEditImgInput)"
            [disabled]="editReviewData.images.length >= 5">
            <i class="bi bi-plus-circle"></i>
            Add Image ({{editReviewData.images.length}}/5)
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEditReview()">
        <i class="bi bi-x-circle"></i> Cancel
      </button>
      <button class="btn btn-primary" (click)="submitEditReview()">
        <i class="bi bi-check-circle"></i> Save Changes
      </button>
    </div>
  </div>
</div>

<!-- Add Review Modal -->
<div class="modal fade show" tabindex="-1" [ngClass]="{'d-block': showAddReviewModal}" *ngIf="showAddReviewModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-chat-quote"></i> Write a Review</h5>
        <button type="button" class="btn-close" (click)="closeAddReviewModal()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitReview()" class="review-form-content">
          <div class="review-form-body">
            <div class="star-rating-input-group mb-2">
              <label class="form-label mb-1">Your Rating</label>
              <div class="star-rating-input">
                <ng-container *ngFor="let s of [1,2,3,4,5]">
                  <i class="bi star-input"
                     [ngClass]="s <= newReview.rating ? 'bi-star-fill' : 'bi-star'"
                     (click)="newReview.rating = s"
                     [class.active]="s <= newReview.rating"></i>
                </ng-container>
                <span class="rating-label ms-2">{{newReview.rating}}/5</span>
              </div>
            </div>
            <div class="form-group mb-2">
              <label class="form-label mb-1">Your Review</label>
              <textarea [(ngModel)]="newReview.comment"
                        name="comment"
                        class="form-control review-textarea"
                        rows="3"
                        placeholder="Share your thoughts..."
                        required></textarea>
            </div>
            <div class="form-group mb-2">
              <label class="form-label mb-1">Add Photos <span class="text-muted">(Optional, up to 5)</span></label>
              <div class="image-upload-row">
                <input type="file"
                       id="reviewImageInput"
                       (change)="onReviewImageSelected($event)"
                       multiple
                       accept="image/*"
                       style="display: none;" />
                <button type="button" class="btn btn-light btn-upload-image" (click)="triggerFileInput('reviewImageInput')">
                  <i class="bi bi-camera"></i> Add Photos
                </button>
                <div class="uploaded-images ms-2" *ngIf="uploadedReviewImages.length > 0">
                  <div *ngFor="let img of uploadedReviewImages; let i = index" class="uploaded-image-thumb">
                    <img [src]="img.imageUrl" alt="Uploaded image">
                    <button type="button" class="remove-image-btn" (click)="removeReviewImage(i)">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="review-form-footer mt-3 text-end">
            <button class="btn btn-primary submit-review-btn px-4" type="submit" [disabled]="isSubmittingReview">
              <span class="spinner-border spinner-border-sm me-2" *ngIf="isSubmittingReview"></span>
              {{ isSubmittingReview ? 'Submitting...' : 'Submit Review' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
</div>

<!-- Edit Review Modal -->
<div class="modal fade show" tabindex="-1" [ngClass]="{'d-block': showEditReviewModal}" *ngIf="showEditReviewModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Your Review</h5>
        <button type="button" class="btn-close" (click)="closeEditReviewModal()"></button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="submitEditReview()" class="review-form-content">
          <div class="review-form-body">
            <div class="star-rating-input-group mb-2">
              <label class="form-label mb-1">Your Rating</label>
              <div class="star-rating-input">
                <ng-container *ngFor="let s of [1,2,3,4,5]">
                  <i class="bi star-input"
                     [ngClass]="s <= editReviewData.rating ? 'bi-star-fill' : 'bi-star'"
                     (click)="editReviewData.rating = s"
                     [class.active]="s <= editReviewData.rating"></i>
                </ng-container>
                <span class="rating-label ms-2">{{editReviewData.rating}}/5</span>
              </div>
            </div>
            <div class="form-group mb-2">
              <label class="form-label mb-1">Your Review</label>
              <textarea [(ngModel)]="editReviewData.comment"
                        name="editComment"
                        class="form-control review-textarea"
                        rows="3"
                        placeholder="Share your thoughts..."
                        required></textarea>
            </div>
            <div class="form-group mb-2">
              <label class="form-label mb-1">Edit Images</label>
              <div class="image-upload-row">
                <div class="uploaded-images" *ngIf="editReviewData.images.length > 0">
                  <div *ngFor="let img of editReviewData.images; let i = index" class="uploaded-image-thumb">
                    <img [src]="img.imageUrl" alt="Review image">
                    <button type="button" class="remove-image-btn" (click)="removeEditReviewImage(i)">
                      <i class="bi bi-x"></i>
                    </button>
                    <input type="file" accept="image/*" (change)="onEditReviewImageSelected($event, i)" style="display:none" #editImgInput>
                    <button type="button" class="btn btn-sm btn-outline-primary ms-1" (click)="editImgInput.click()">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </div>
                <input type="file" #addEditImgInput style="display:none" (change)="onAddEditReviewImageSelected($event)">
                <button type="button" class="btn btn-outline-success add-image-btn ms-2" (click)="addEditReviewImage(addEditImgInput)" [disabled]="editReviewData.images.length >= 5">
                  <i class="bi bi-plus-circle"></i> Add Image ({{editReviewData.images.length}}/5)
                </button>
              </div>
            </div>
          </div>
          <div class="review-form-footer mt-3 text-end">
            <button class="btn btn-primary submit-review-btn px-4" type="submit">
              <span class="spinner-border spinner-border-sm me-2" *ngIf="isSubmittingReview"></span>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal-backdrop fade show"></div>
</div>