<app-header></app-header>

<!-- Mobile Filter Toggle -->
<div class="mobile-filter-toggle d-md-none">
  <button 
    class="btn btn-outline-primary w-100 mb-3"
    (click)="toggleMobileFilters()">
    <i class="pi pi-filter me-2"></i>
    Filters
    <span class="badge bg-primary ms-2" *ngIf="activeFilterCount > 0">
      {{ activeFilterCount }}
    </span>
  </button>
</div>

<!-- Filter Sidebar -->
<app-filter-sidebar
  [categories]="categories"
  [brands]="brands"
  [isVisible]="showFilters"
  (filtersChanged)="onFiltersChanged($event)"
  (clearAllFilters)="onClearAllFilters()">
</app-filter-sidebar>

<!-- Mobile Backdrop -->
<div 
  class="mobile-backdrop d-md-none"
  [class.show]="showFilters"
  (click)="closeMobileFilters()">
</div>

<!-- Main Content -->
<main class="main-content" [class.with-sidebar]="showFilters">
  <div class="container-fluid">
    
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Products</li>
      </ol>
    </nav>

    <!-- Header Section -->
    <div class="products-header">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
          <!-- Desktop Filter Toggle -->
          <button 
            class="btn btn-outline-secondary me-3 d-none d-md-inline-flex"
            (click)="toggleFilters()">
            <i class="pi pi-filter me-2"></i>
            {{ showFilters ? 'Hide' : 'Show' }} Filters
          </button>
          
          <!-- Category Dropdown - Moved to left side -->
          <app-category-dropdown 
            [categories]="categories"
            (categorySelected)="onCategorySelected($event)"
            (viewAllCategories)="onViewAllCategories()">
          </app-category-dropdown>
          
          <div class="ms-3">
            <h5 class="mb-0">Products</h5>
            <small class="text-muted">{{ filteredProducts.length }} of {{ products.length }} items</small>
          </div>
        </div>

        <!-- Sort Options Only -->
        <div class="d-flex gap-2 align-items-center">
          <!-- Sort Dropdown -->
          <div class="dropdown">
            <button 
              class="btn btn-outline-secondary dropdown-toggle" 
              type="button" 
              data-bs-toggle="dropdown">
              <i class="pi pi-sort me-2"></i>
              {{ currentSortLabel }}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" (click)="setSortOption('featured')">Featured</a></li>
              <li><a class="dropdown-item" (click)="setSortOption('price-asc')">Price: Low to High</a></li>
              <li><a class="dropdown-item" (click)="setSortOption('price-desc')">Price: High to Low</a></li>
              <li><a class="dropdown-item" (click)="setSortOption('name-asc')">Name: A to Z</a></li>
              <li><a class="dropdown-item" (click)="setSortOption('newest')">Newest First</a></li>
              <li><a class="dropdown-item" (click)="setSortOption('rating')">Highest Rated</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Active Filters Display -->
      <div class="active-filters mb-3" *ngIf="hasActiveFilters()">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <span class="text-muted small me-2">Active filters:</span>
          
          <!-- Category Filters -->
          <span *ngFor="let categoryId of currentFilters.categories" 
                class="badge bg-primary filter-badge">
            {{ getCategoryName(categoryId) }}
            <button class="btn-close btn-close-white ms-1" 
                    (click)="removeCategoryFilter(categoryId)"></button>
          </span>
          
          <!-- Brand Filters -->
          <span *ngFor="let brandId of currentFilters.brands" 
                class="badge bg-info filter-badge">
            {{ getBrandName(brandId) }}
            <button class="btn-close btn-close-white ms-1" 
                    (click)="removeBrandFilter(brandId)"></button>
          </span>
          
          <!-- Price Filter -->
          <span *ngIf="currentFilters.priceRange.min !== null || currentFilters.priceRange.max !== null" 
                class="badge bg-success filter-badge">
            ${{ currentFilters.priceRange.min || 0 }} - ${{ currentFilters.priceRange.max || 'âˆž' }}
            <button class="btn-close btn-close-white ms-1" 
                    (click)="removePriceFilter()"></button>
          </span>
          
          <!-- Other Filters -->
          <span *ngIf="currentFilters.inStock" class="badge bg-warning filter-badge">
            In Stock
            <button class="btn-close btn-close-white ms-1" 
                    (click)="removeStockFilter()"></button>
          </span>
          
          <span *ngIf="currentFilters.onSale" class="badge bg-danger filter-badge">
            On Sale
            <button class="btn-close btn-close-white ms-1" 
                    (click)="removeSaleFilter()"></button>
          </span>
          
          <button class="btn btn-link btn-sm p-0 ms-2" (click)="clearAllFilters()">
            Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- Product Grid -->
    <div class="products-container">
      <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-3">
        <div class="col" *ngFor="let product of paginatedProducts">
          <div class="card h-100 product-card">
            <!-- Product Image Container -->
            <div class="position-relative product-img-wrapper">
              <!-- Badges -->
              <div class="position-absolute top-0 start-0 p-1 z-1">
                <span class="badge bg-danger small py-1" *ngIf="isOnSale(product)">SALE</span>
                <span class="badge bg-primary small py-1 ms-1" *ngIf="isNew(product)">NEW</span>
              </div>

              <!-- Wishlist Button -->
              <button
                class="btn btn-sm position-absolute top-0 end-0 p-1 m-1 bg-white rounded-circle shadow-sm wishlist-btn z-1"
                title="Add to wishlist" (click)="toggleWish(product.product.id!)">
                <i class="pi" [ngClass]="isWished(product.product.id!) ? 'pi-heart-fill text-danger' : 'pi-heart'"
                  style="cursor: pointer; font-size: 1.2rem;"></i>
              </button>

              <!-- Product Image -->
              <img [src]="getMainProductImage(product.product)" class="card-img-top" (click)="goToDetail(product)"
                alt="{{ product.product.name }}" style="height: 180px; object-fit: contain; background: #f8f9fa;">

              <!-- Quick View Overlay -->
              <div class="position-absolute bottom-0 start-0 end-0 p-1 text-center quick-view-btn">
                <button class="btn btn-sm btn-light w-100 py-1" style="font-size: 0.8rem;"
                  (click)="quickView(product, $event)">
                  Quick View
                </button>
              </div>
            </div>

            <!-- Product Info -->
            <div class="card-body p-2" (click)="goToDetail(product)">
              <!-- Brand & Category -->
              <div class="d-flex justify-content-between">
                <small class="text-muted" style="font-size: 0.75rem;">{{ product.brand.name }}</small>
                <small class="text-muted" style="font-size: 0.75rem;">{{ product.category.name }}</small>
              </div>

              <!-- Product Name -->
              <h6 class="product-name mt-1 mb-1" title="{{ product.product.name }}">
                {{ product.product.name }}
              </h6>

              <!-- Variant Preview -->
              <div class="variant-preview mb-1" *ngIf="hasColorVariants(product)">
                <div class="d-flex gap-1 align-items-center">
                  <div *ngFor="let color of getColorOptions(product).slice(0, 3)" class="color-dot"
                    [style.background-color]="color.value" [title]="color.name">
                  </div>
                  <small *ngIf="getColorOptions(product).length > 3" class="text-muted ms-1" style="font-size: 0.7rem;">
                    +{{ getColorOptions(product).length - 3 }} more
                  </small>
                </div>
              </div>

              <!-- Price & Stock -->
              <div class="d-flex justify-content-between align-items-center mt-2">
                <div>
                  <span class="fw-bold" style="font-size: 0.95rem;">${{ getLowestPrice(product) }}</span>
                  <span class="text-decoration-line-through text-muted ms-1" style="font-size: 0.8rem;"
                    *ngIf="isOnSale(product)">
                    ${{ product.product.basePrice }}
                  </span>
                </div>

                <span class="stock-badge" [ngClass]="{'in-stock': hasStock(product), 'out-of-stock': !hasStock(product)}">
                  {{ hasStock(product) ? 'In Stock' : 'Out of Stock' }}
                </span>
              </div>

              <!-- Action Button -->
              <button class="btn btn-primary btn-sm w-100 mt-2" [disabled]="!hasStock(product)"
                (click)="viewProduct(product)">
                View Details
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="filteredProducts.length === 0" class="empty-state text-center py-5">
        <i class="pi pi-search" style="font-size: 4rem; color: #6c757d;"></i>
        <h4 class="mt-3 text-muted">No products found</h4>
        <p class="text-muted">Try adjusting your filters or search criteria</p>
        <button class="btn btn-primary" (click)="clearAllFilters()">Clear All Filters</button>
      </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Product pagination" class="mt-4" *ngIf="filteredProducts.length > 0">
      <div class="d-flex justify-content-between align-items-center">
        <div class="pagination-info">
          <small class="text-muted">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to 
            {{ Math.min(currentPage * itemsPerPage, filteredProducts.length) }} 
            of {{ filteredProducts.length }} results
          </small>
        </div>
        
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="goToPage(currentPage - 1)">Previous</a>
          </li>
          <li *ngFor="let page of getPageNumbers()" 
              class="page-item" 
              [class.active]="page === currentPage">
            <a class="page-link" (click)="goToPage(page)">{{ page }}</a>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="goToPage(currentPage + 1)">Next</a>
          </li>
        </ul>
      </div>
    </nav>

  </div>
</main>
