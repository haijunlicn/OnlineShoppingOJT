<app-header></app-header>

<main class="main-content">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-section">
    <div class="loading-card">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
      </div>
      <h3>Loading order details...</h3>
      <p>Please wait while we fetch your order information</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-section">
    <div class="error-card">
      <div class="error-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h3>Something went wrong</h3>
      <p>{{ error }}</p>
      <button class="btn-retry" (click)="loadOrderDetails()">
        <i class="fas fa-redo"></i>
        <span>Try Again</span>
      </button>
    </div>
  </div>

  <!-- Order Details -->
  <div *ngIf="order && !loading" class="order-detail-container">

    <!-- Header Section -->
    <div class="order-header">
      <div class="breadcrumb-nav">
        <a routerLink="/customer/orders" class="breadcrumb-link">
          <i class="fas fa-arrow-left"></i>
          <span>Orders</span>
        </a>
        <i class="fas fa-chevron-right breadcrumb-separator"></i>
        <span class="breadcrumb-current">Order Details</span>
      </div>

      <div class="header-main">
        <div class="header-left">
          <div class="header-title-section">
            <h1>Order-{{ order.trackingNumber }}</h1>
            <div class="header-meta">
              <span class="order-date">Order date {{ formatDate(order.createdDate) }}</span>
              <span class="order-source">Order from <strong>{{ order.user.name }}</strong></span>
              <span class="order-purchase">Purchased via online store</span>
            </div>
          </div>
        </div>

        <div class="header-right">
          <div class="header-actions">
            <button class="btn-action secondary" (click)="downloadInvoice()">
              <span>Download Invoice</span>
            </button>
            <button class="btn-action secondary" (click)="trackOrder()">
              <span>Track Order</span>
            </button>
            <button class="btn-action primary" (click)="contactSupport()">
              <span>Contact Support</span>
            </button>
          </div>
          <div class="order-status-info">
            <span class="order-number">Order {{ order.id }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Section -->
    <div class="status-section">
      <div class="status-card">
        <div class="status-icon">
          <i [class]="getStatusIcon(order.paymentStatus)"></i>
        </div>
        <div class="status-content">
          <h3>{{ getStatusMessage(order.paymentStatus) }}</h3>
          <div class="status-details">
            <div class="status-location">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{ order.shippingAddress.township }}, {{ order.shippingAddress.city }}</span>
            </div>
            <div class="status-progress">
              <div class="progress-line" [style.width.%]="getProgressPercent()"></div>
            </div>
            <div class="status-destination">
              <i class="fas fa-home"></i>
              <span>{{ order.user.name }}'s Address, {{ order.shippingAddress.city }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="delivery-info">
        <div class="delivery-item">
          <div class="delivery-icon">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <div class="delivery-content">
            <div class="delivery-label">Order Date</div>
            <div class="delivery-value">{{ formatDate(order.createdDate) }}</div>
          </div>
        </div>

        <div class="delivery-item">
          <div class="delivery-icon">
            <i class="fas fa-truck"></i>
          </div>
          <div class="delivery-content">
            <div class="delivery-label">Delivery Method</div>
            <div class="delivery-value">{{ order.deliveryMethod.name }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar Section -->
    <div class="status-bar-section">
      <div class="status-bar-header">
        <h3>Order Status</h3>
      </div>

      <div class="status-bar-container">
        <div class="status-bar-track">
          <div *ngFor="let status of getStatusSteps(); let i = index" class="status-step" [ngClass]="status.class">
            <div class="step-circle">
              <i [class]="status.icon"></i>
            </div>
            <div class="step-label">{{ status.label }}</div>
            <div *ngIf="i < getStatusSteps().length - 1" class="step-connector" [ngClass]="status.connectorClass"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Shipment Section -->
        <div class="section-card">
          <div class="section-header">
            <h3>Shipment</h3>
          </div>
          <div class="shipment-content">
            <div class="shipment-provider">
              <div class="provider-name">{{ order.deliveryMethod.name }} Delivery</div>
              <div class="provider-location">{{ order.shippingAddress.city }}, {{ order.shippingAddress.country }}</div>
            </div>

            <div class="recipient-info">
              <div class="recipient-label">Recipient</div>
              <div class="recipient-name">{{ order.user.name }}</div>

              <div class="delivery-address-label">Delivery address</div>
              <div class="delivery-address">
                {{ order.shippingAddress.address }}<span *ngIf="order.shippingAddress.township">, {{
                  order.shippingAddress.township }}</span>, {{ order.shippingAddress.city }} {{
                order.shippingAddress.zipCode }}
              </div>

              <div class="tracking-info">
                <div class="tracking-label">Tracking No.</div>
                <div class="tracking-number">
                  {{ order.trackingNumber }}
                  <button class="btn-copy" (click)="copyTrackingNumber()">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Items Section -->
        <div class="section-card">
          <div class="section-header">
            <h3>Items <span class="item-count">{{ getTotalItems() }}</span></h3>
          </div>
          <div class="items-content">
            <div *ngFor="let item of order.items" class="item-row">
              <div class="item-image">
                <img [src]="item.variant.imgPath || 'assets/img/default-product.jpg'" [alt]="item.product.name"
                  (error)="onImageError($event)">
              </div>
              <div class="item-details">
                <div class="item-name">{{ item.product.name }}</div>
                <div class="item-meta">
                  <span class="item-sku">SKU: {{ item.variant.sku }}</span>
                  <span class="item-qty">Qty: {{ item.quantity }}</span>
                </div>
              </div>
              <div class="item-price">{{ formatCurrency(item.totalPrice) }}</div>
            </div>
          </div>
        </div>

        <!-- Order Summary -->
        <div class="section-card">
          <div class="section-header">
            <h3>Order Summary</h3>
            <div class="payment-status">
              <span class="payment-badge" [ngClass]="getOrderStatusClass(order.paymentStatus)">{{ order.paymentStatus
                }}</span>
            </div>
          </div>
          <div class="summary-content">
            <div class="summary-text">Here's your summary for the items you purchased.</div>

            <div class="summary-items">
              <div *ngFor="let item of order.items" class="summary-item">
                <span class="summary-item-name">{{ item.product.name }} ({{ item.quantity }}x)</span>
                <span class="summary-item-price">{{ formatCurrency(item.totalPrice) }}</span>
              </div>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-row">
              <span>Subtotal</span>
              <span>{{ formatCurrency(getSubtotal()) }}</span>
            </div>
            <div class="summary-row">
              <span>Shipping Fee</span>
              <span>{{ formatCurrency(order.shippingFee) }}</span>
            </div>

            <div class="summary-divider"></div>

            <div class="summary-total">
              <span>Total</span>
              <span>{{ formatCurrency(order.totalAmount) }}</span>
            </div>

            <div class="summary-note">{{ formatCurrency(order.totalAmount) }} ({{ getTotalItems() }} items)</div>

            <div class="summary-actions">
              <button class="btn-contact" (click)="contactSupport()">Contact Support</button>
              <button class="btn-invoice" (click)="downloadInvoice()">Download Invoice</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Customer Info -->
        <div class="info-card">
          <div class="info-header">
            <h3>Customer</h3>
          </div>
          <div class="customer-content">
            <div class="customer-profile">
              <div class="customer-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="customer-details">
                <div class="customer-name">{{ order.user.name }}</div>
                <div class="customer-email">{{ order.user.email }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address -->
        <div class="info-card">
          <div class="info-header">
            <h3>Shipping Address</h3>
          </div>
          <div class="address-content">
            <div class="address-details">
              <div class="address-name">{{ order.user.name }}</div>
              <div class="address-text">
                {{
                order.shippingAddress.address
                + (order.shippingAddress.township ? ', ' + order.shippingAddress.township : '')
                + ', ' + order.shippingAddress.city
                + ', ' + order.shippingAddress.zipCode
                + ', ' + order.shippingAddress.country
                + (order.shippingAddress.phoneNumber ? ' (Phone: ' + order.shippingAddress.phoneNumber + ')' : '')
                }}
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Information -->
        <div *ngIf="order.paymentMethod" class="info-card">
          <div class="info-header">
            <h3>Payment Information</h3>
          </div>
          <div class="payment-content">
            <div class="payment-method">
              <div class="payment-icon">
                <img [src]="order.paymentMethod.logo" [alt]="order.paymentMethod.methodName"
                  (error)="onPaymentLogoError($event)">
              </div>
              <div class="payment-details">
                <div class="payment-name">{{ order.paymentMethod.methodName }}</div>
                <div class="payment-type">{{ order.paymentMethod.type | titlecase }}</div>
              </div>
            </div>

            <div *ngIf="order.paymentProofPath" class="payment-proof">
              <div class="proof-label">Payment Proof</div>
              <img [src]="order.paymentProofPath" alt="Payment Proof" class="proof-image" (click)="viewPaymentProof()">
            </div>
          </div>
        </div>

        <!-- Delivery Method -->
        <div class="info-card">
          <div class="info-header">
            <h3>Delivery Method</h3>
          </div>
          <div class="delivery-method-content">
            <div class="delivery-method-info">
              <div class="delivery-icon">
                <i [class]="getDeliveryMethodIcon(order.deliveryMethod.name)"></i>
              </div>
              <div class="delivery-details">
                <div class="delivery-name">{{ order.deliveryMethod.name }}</div>
                <div class="delivery-fee">Base Fee: {{ formatCurrency(order.deliveryMethod.baseFee) }}</div>
                <div *ngIf="order.deliveryMethod.feePerKm" class="delivery-per-km">Per KM: {{
                  formatCurrency(order.deliveryMethod.feePerKm) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>